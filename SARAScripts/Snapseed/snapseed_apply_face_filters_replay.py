# coding=utf8

import os
import sys
import time
import json
import frida
import argparse
import traceback
import uiautomator2 as u2
sys.path.append(os.path.abspath(os.getcwd()))
from script import util

frida_session = None
xml = None
view_hierarchy = None
save_path = None
action_count = 0
current_popup_window = None
curr_webview_address = None

d = u2.connect()
print(d.info)


def log(desc):
    global action_count
    print('[ReplayAction]-%d: ' % action_count, desc)


def error_handler(func):
    def wrapper(message, data):
        if message['type'] == 'error':
            print('[Func]: %s, [Error-msg]: %s' % (func.__name__, message))
            print('[Func]: %s, [Error-des]: %s' % (func.__name__, message['description']))
            print('[Func]: %s, [Error-sta]: %s' % (func.__name__, message['stack']))
            print('[Func]: %s, [Error-dat]: %s' % (func.__name__, data))
            return None
        else:
            return func(message, data)
    return wrapper


def preprocess_path():
    global save_path
    if save_path is None:
        return False
    if not os.path.exists(save_path):
        os.mkdir(save_path)
    else:
        for file in os.listdir(save_path):
            os.remove(os.path.join(save_path, file))
    return True


def post_action(custom_interval):
    global xml
    global d
    global action_count
    global save_path
    global view_hierarchy

    print('[ReplayTimeInterval]-%d: %s' % (action_count, json.dumps({'interval': custom_interval})))
    if action_count > 0:
        # time.sleep(1)
        if custom_interval > 0:
            time.sleep(custom_interval)
    xml = d.dump_hierarchy()
    xml = util.parse_xml(xml)
    screenshot_filename = os.path.join(save_path, '_'.join(['screenshot', str(action_count)]) + '.jpg')
    xml_filename = os.path.join(save_path, '_'.join(['ui', str(action_count)]) + '.xml')
    view_hierarchy_filename = os.path.join(save_path, '_'.join(['view_hierarchy', str(action_count)]) + '.xml')
    d.screenshot(screenshot_filename)
    util.save_xml(xml, xml_filename)
    view_hierarchy, lxml_view_hierarchy = util.dump_view_hierarchy(d, view_hierarchy_filename)
    action_count += 1


def set_text(rid, bounds, text):
    global xml
    view = util.find_view(rid, bounds, xml)
    if view is None:
        print('TextView ' + rid + ' does not exist')
    else:
        if len(rid) > 0:
            d(resourceId=rid, focused=True).set_text(text)
        else:
            d(focused=True).set_text(text)
        log('[set_text]-%s' % json.dumps({'rid': rid, 'text': text, 'bounds': bounds}))


def press_soft_keyboard(key_name):
    global xml
    index = util.find_soft_key(key_name, xml)
    if index is None:
        raise Exception('Key ' + key_name + ' does not exist')
    key_x, key_y = index[0], index[1]
    d.click(key_x, key_y)
    log('[press_key]-%s' % json.dumps({'key_name': key_name}))


def hide_soft_keyboard():
    global xml
    if util.check_soft_keyboard(xml):
        print('Hide soft keyboard')
        d.press('back')
        log('[hide_keyboard]')


def record_popup_window():
    global current_popup_window
    current_popup_window = util.get_current_window(d)
    log('[record_popup_window]-%s' % json.dumps({'window': current_popup_window}))


def close_popup_window():
    global current_popup_window
    if current_popup_window is not None:
        window = util.get_current_window(d)
        if window == current_popup_window:
            d.press('back')
            log('[hide_popup_window]-%s' % json.dumps({'window': current_popup_window}))
            current_popup_window = None


def clean_up():
    global frida_session
    print('Clean Up....')
    frida_session.detach()


def detect_webview():
    # Get WebView handle
    global frida_session
    instrument_script = frida_session.create_script(util.instrument_WebView())
    instrument_script.on('message', get_instrument_WebView_message)
    instrument_script.load()


@error_handler
def get_instrument_WebView_message(message, data):
    global curr_webview_address
    print('[WebView]: ', message)
    curr_webview_address = util.get_view_address(message['payload']['webview'])


def perform_click_event(tap_type, x, y, duration, view_type):
    global action_count
    global view_hierarchy
    global frida_session

    if view_type == 'Activity':
        candidates = util.find_component_candidates(view_hierarchy, x, y)
        # Instrument
        instrument_script = None
        code = util.instrument_view([candidate['classname'] for candidate in candidates], [candidate['address'] for candidate in candidates], action_count)
        instrument_script = frida_session.create_script(code)
        instrument_script.on('message', get_instrument_view_message)
        instrument_script.load()
        if tap_type == 'LongTap':
            d.long_click(x, y, duration)
        elif tap_type == 'Tap':
            d.long_click(x, y, duration)
        elif tap_type == 'DoubleTap':
            d.double_click(x, y, 0.1)

        # time.sleep(1)
        instrument_script.unload()
        log('[click]-%s' % json.dumps({'tap_type': tap_type, 'x': x, 'y': y, 'duration': duration, 'candidate': candidates, 'view_type': view_type}))

    else:
        # Dialog & PopupWindow
        # command `adb shell dumpsys activity top` fails to extract view hierarchy of Dialog & PopupWindow
        if tap_type == 'LongTap':
            d.long_click(x, y, duration)
        elif tap_type == 'Tap':
            d.long_click(x, y, duration)
        elif tap_type == 'DoubleTap':
            d.double_click(x, y, 0.1)
        log('[click]-%s' % json.dumps({'tap_type': tap_type, 'x': x, 'y': y, 'duration': duration, 'view_type': view_type}))


@error_handler
def get_instrument_view_message(message, data):
    print('[ReplayViewInstrumentation]: %s' % json.dumps(message))


def perform_swipe_event(pointers, duration=0.01):
    d.swipe_points(pointers, duration)
    log('[swipe]-%s' % json.dumps({'pointers': pointers, 'duration': duration}))


def perform_key_event(key_code):
    d.press(key_code)
    log('[press]-%s' % json.dumps({'key_code': key_code}))


def webview_set_text(input_selector, text, webview_classname, package_name):
    # Set Text
    global curr_webview_address
    code = util.webview_set_text(input_selector, text, webview_classname, curr_webview_address, package_name)
    instrument_script = frida_session.create_script(code)
    instrument_script.on('message', get_webview_set_text_message)
    instrument_script.load()


def webview_set_text_with_u2(text):
    d(focused=True).set_text(text)
    log('[webview_set_text]-%s' % json.dumps({'text': text}))


@error_handler
def get_webview_set_text_message(message, data):
    print('[WebViewSetText]: ', message)


def instrument_chrome_client():
    code = util.instrument_chrome_client()
    script = frida_session.create_script(code)
    script.on('message', get_instrument_chrome_client_message)
    script.load()


@error_handler
def get_instrument_chrome_client_message(message, data):
    print('[Console]: ', message)


if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='Argument Parser')
    parser.add_argument('--path', help='save path', required=True)
    parser.add_argument('--package', help='package name', required=True)
    parser.add_argument('--pid', help='pid name', required=True)
    args = parser.parse_args()
    
    save_path = args.path
    package_name = args.package
    pid = int(args.pid)

    if not preprocess_path():
        print('Save path not found')
        sys.exit()

    # Setup Dynamic instrument   
    all_devices = frida.enumerate_devices()
    device = frida.get_usb_device()

    # Attach
    frida_session = device.attach(pid)
    print(frida_session)

    try:
        detect_webview()
        # instrument_chrome_client()
        post_action(0)

        perform_click_event("Tap", 614.147034, 1073.161621, 0.080000, "Activity")
        post_action(1.038942)
        perform_swipe_event([(408.4327392578125, 1118.12646484375), (413.4822082519531, 1080.7884521484375), (417.75506591796875, 1054.99658203125), (424.6471862792969, 1012.5328369140625), (432.11651611328125, 972.37353515625), (442.17730712890625, 934.4063720703125), (453.35321044921875, 884.149169921875), (459.03436279296875, 826.6119995117188), (460.3606262207031, 729.78857421875), (463.88427734375, 670.1337280273438), (468.34954833984375, 625.5113525390625), (481.7135314941406, 566.7973022460938), (495.63299560546875, 519.968994140625), (505.47418212890625, 474.33636474609375), (513.5987548828125, 437.4879150390625), (519.778076171875, 405.68304443359375), (523.1668090820312, 390.90771484375), (526.3590087890625, 378.16448974609375), (530.5926513671875, 366.0548400878906), (532.2152099609375, 359.81005859375), (533.2593994140625, 357.3108215332031), (534.2579956054688, 357.72052001953125)], 0.033000)
        post_action(4.209731)
        perform_swipe_event([(434.39666748046875, 1106.1358642578125), (428.40374755859375, 1077.3521728515625), (429.40362548828125, 1052.9581298828125), (433.89495849609375, 1003.7327270507812), (445.097900390625, 934.00341796875), (455.48992919921875, 875.0055541992188), (466.6202392578125, 785.10595703125), (474.8525390625, 718.4764404296875), (482.3301086425781, 662.482421875), (495.74871826171875, 602.0203247070312), (503.85101318359375, 574.8052368164062), (516.0387573242188, 526.5667724609375), (526.063232421875, 487.36138916015625), (536.2552490234375, 446.65106201171875), (540.2496337890625, 433.66119384765625), (549.61279296875, 402.55706787109375), (552.9756469726562, 389.96868896484375), (559.4317626953125, 374.0815124511719), (563.06591796875, 360.47882080078125), (568.092529296875, 341.6477966308594), (573.44189453125, 328.6473388671875), (577.3082885742188, 315.20343017578125), (580.615478515625, 303.653564453125), (581.9248046875, 292.10662841796875), (582.19140625, 286.9305419921875), (583.5999145507812, 275.7320861816406), (583.666015625, 271.8809509277344), (584.1886596679688, 263.7867431640625), (585.187255859375, 254.51947021484375), (586.1858520507812, 249.55873107910156), (588.0101928710938, 240.50469970703125), (589.3251342773438, 235.24159240722656), (591.4468383789062, 227.7490997314453), (592.1775512695312, 222.8614501953125), (593.1761474609375, 216.2015380859375), (594.3173217773438, 212.4056854248047), (595.6727294921875, 207.837646484375), (595.8491821289062, 206.16220092773438), (598.3178100585938, 203.69207763671875), (599.2943725585938, 202.71490478515625)], 0.033000)
        post_action(0.917135)
        perform_click_event("Tap", 257.642181, 1185.074219, 0.098000, "Activity")
        post_action(5.194915)
        perform_swipe_event([(136.8099822998047, 1112.131103515625), (177.28614807128906, 1114.0074462890625), (195.64456176757812, 1115.3369140625), (233.44984436035156, 1116.1280517578125), (254.278076171875, 1117.22900390625), (283.5226745605469, 1117.127197265625), (302.3550720214844, 1117.127197265625), (335.9414978027344, 1116.1280517578125), (359.1383056640625, 1113.9573974609375), (381.70489501953125, 1112.705078125), (420.16522216796875, 1107.9400634765625), (462.7618408203125, 1101.8912353515625), (479.5683898925781, 1097.851806640625), (516.7822265625, 1090.64794921875), (531.528564453125, 1089.4599609375), (556.291259765625, 1086.9215087890625), (566.4074096679688, 1085.796875), (584.5442504882812, 1084.4267578125), (592.5432739257812, 1084.1529541015625), (603.927490234375, 1084.1529541015625), (612.1498413085938, 1084.1529541015625), (619.1875610351562, 1084.1529541015625), (623.1358642578125, 1083.1533203125), (625.2648315429688, 1083.15380859375), (628.0484008789062, 1083.15380859375), (627.1290283203125, 1083.15380859375)], 0.020000)
        post_action(0.498041)
        perform_swipe_event([(155.78363037109375, 1119.125732421875), (186.96337890625, 1118.2081298828125), (225.0442657470703, 1118.12646484375), (265.94903564453125, 1118.8505859375), (307.7102966308594, 1122.64013671875), (327.3747253417969, 1123.7528076171875), (356.7945556640625, 1124.989501953125), (370.8836975097656, 1125.1209716796875), (399.44525146484375, 1126.1202392578125), (411.0340881347656, 1125.4869384765625), (425.96099853515625, 1125.1209716796875), (450.5641784667969, 1124.121826171875), (465.7651062011719, 1122.671875), (491.05816650390625, 1119.3970947265625), (502.8589782714844, 1117.2254638671875), (526.4877319335938, 1114.7713623046875), (536.7792358398438, 1112.67822265625), (559.8319702148438, 1109.1768798828125), (577.0328979492188, 1105.8740234375), (585.54638671875, 1104.137451171875), (597.5808715820312, 1103.13818359375), (608.1027221679688, 1101.9495849609375), (614.3529052734375, 1101.587890625), (622.7244873046875, 1101.1397705078125), (626.2064208984375, 1101.1397705078125), (632.492919921875, 1100.1405029296875), (632.1220703125, 1100.1405029296875)], 0.033000)
        post_action(0.523498)
        perform_click_event("Tap", 77.891815, 1100.140503, 0.128000, "Activity")
        post_action(1.571258)
        perform_click_event("Tap", 223.689331, 1104.137451, 0.126000, "Activity")
        post_action(4.192835)
        perform_click_event("Tap", 381.470184, 1095.144409, 0.156000, "Activity")
        post_action(2.068120)
        perform_swipe_event([(571.2066650390625, 834.34814453125), (552.2330322265625, 839.34423828125), (542.2468872070312, 842.3419189453125), (530.36962890625, 846.7986450195312), (527.3634643554688, 848.4056396484375), (525.2704467773438, 849.33642578125), (512.5160522460938, 854.7752685546875), (504.81988525390625, 859.1551513671875), (501.2577209472656, 860.3432006835938), (495.4139099121094, 862.6254272460938), (491.3175964355469, 864.8244018554688), (486.0258483886719, 867.4718627929688), (481.9883117675781, 869.662841796875), (476.5968322753906, 871.3192749023438), (472.0404357910156, 873.4696044921875), (468.34954833984375, 875.8157958984375), (463.3265380859375, 878.3287963867188), (460.2012939453125, 880.4716796875), (457.6322937011719, 882.04296875), (455.3552551269531, 883.3099365234375), (454.0242919921875, 884.6539916992188), (451.9683837890625, 885.7119140625), (450.5276184082031, 885.308349609375), (449.3758850097656, 885.308349609375), (448.0411376953125, 886.6438598632812), (446.8793640136719, 886.3075561523438), (446.5316467285156, 887.1550903320312), (444.0911560058594, 888.597900390625), (443.0989074707031, 889.5906982421875), (439.5087585449219, 892.1837768554688), (437.5870056152344, 894.106689453125), (432.44134521484375, 896.7783813476562), (431.900146484375, 896.2997436523438), (427.37091064453125, 899.315185546875), (425.06689453125, 900.4678344726562), (418.9316711425781, 902.7902221679688), (415.908447265625, 905.0498657226562), (412.1391296386719, 907.5794067382812), (408.59735107421875, 908.2904052734375), (406.4280700683594, 909.2896118164062), (404.0910339355469, 909.2896118164062), (400.943115234375, 910.288818359375), (398.9459228515625, 912.7869262695312), (396.16851806640625, 913.2864990234375), (392.5520935058594, 915.284912109375), (389.9583740234375, 916.2841796875), (387.7864685058594, 917.2833862304688), (385.4646301269531, 919.4183349609375), (384.4660339355469, 920.1299438476562), (384.4660339355469, 920.281005859375)], 0.033000)
        post_action(1.092347)
        perform_swipe_event([(406.4355163574219, 924.2778930664062), (431.732666015625, 919.2153930664062), (435.8582763671875, 919.0989990234375), (438.4621276855469, 919.2817993164062), (453.29888916015625, 918.1795043945312), (464.1836853027344, 916.8052368164062), (471.0598449707031, 916.2841796875), (480.8099670410156, 916.2841796875), (488.998046875, 915.284912109375), (495.1324157714844, 914.2857055664062), (497.84625244140625, 914.2857055664062), (502.9955749511719, 912.939697265625), (511.1321716308594, 913.2864990234375), (518.0485229492188, 912.2872924804688), (523.2733154296875, 912.2872924804688), (529.42822265625, 911.2880249023438), (534.6702270507812, 911.2880249023438), (537.9693603515625, 911.2880249023438), (542.0612182617188, 910.288818359375), (546.027099609375, 910.288818359375), (546.7406005859375, 910.288818359375), (551.0414428710938, 910.288818359375), (553.377685546875, 910.288818359375), (557.00146484375, 908.9024047851562), (560.221923828125, 909.2896118164062), (562.2191772460938, 909.2896118164062), (565.5126342773438, 909.2896118164062), (571.0091552734375, 909.2896118164062), (574.5901489257812, 909.2896118164062), (579.195556640625, 909.2896118164062), (583.1900024414062, 909.2896118164062), (586.5048217773438, 909.2896118164062), (589.9158935546875, 909.2896118164062), (593.1696166992188, 909.2896118164062), (596.5964965820312, 909.2896118164062), (599.9645385742188, 909.2896118164062), (603.1407470703125, 909.2896118164062), (606.1991577148438, 909.2896118164062), (609.666015625, 908.2904052734375), (614.5784912109375, 908.2904052734375), (618.2459106445312, 908.2904052734375), (622.7296142578125, 908.2904052734375), (625.85009765625, 907.2911987304688), (628.9335327148438, 907.2911987304688), (632.1298217773438, 906.2919311523438), (635.7236938476562, 906.2919311523438), (640.6102905273438, 905.292724609375), (647.55859375, 903.2943115234375), (651.5997314453125, 902.2951049804688), (655.7862548828125, 901.2958374023438), (658.2234497070312, 900.1591186523438), (659.5838623046875, 900.296630859375), (660.083251953125, 900.296630859375), (661.0818481445312, 900.296630859375), (662.0804443359375, 900.296630859375), (663.0791015625, 900.296630859375), (664.0776977539062, 900.296630859375), (665.5564575195312, 900.296630859375), (670.0693359375, 900.296630859375), (672.0665893554688, 900.296630859375)], 0.033000)
        post_action(0.296931)
        perform_swipe_event([(432.3994445800781, 950.2576293945312), (450.6312561035156, 950.2576293945312), (473.2477111816406, 947.6588745117188), (485.10479736328125, 946.9637451171875), (501.2161560058594, 945.279052734375), (514.0521850585938, 943.9681396484375), (523.273193359375, 942.763427734375), (534.8602294921875, 942.1132202148438), (542.000732421875, 942.2638549804688), (549.8023071289062, 942.2638549804688), (553.749267578125, 942.2638549804688), (561.6446533203125, 942.2638549804688), (565.5035400390625, 942.2638549804688), (571.4603271484375, 942.2638549804688), (577.0927124023438, 942.2638549804688), (580.6546630859375, 942.2638549804688), (583.469482421875, 942.2638549804688), (585.5428466796875, 942.2638549804688), (586.9548950195312, 942.2638549804688), (588.18310546875, 942.2638549804688), (589.1817016601562, 942.2638549804688), (588.18310546875, 942.2638549804688), (587.4684448242188, 942.2638549804688), (587.1845092773438, 942.2638549804688), (585.9293823242188, 942.2638549804688), (586.1858520507812, 943.634521484375), (584.8553466796875, 943.2630615234375), (582.4654541015625, 943.2630615234375), (581.2545776367188, 944.2005004882812), (579.29541015625, 944.2622680664062), (575.489013671875, 945.4985961914062), (573.2039184570312, 945.2615356445312), (569.708740234375, 946.7603759765625), (566.9664916992188, 946.2607421875), (564.10595703125, 947.315185546875), (561.7553100585938, 947.2599487304688), (558.6156616210938, 948.4618530273438), (554.7295532226562, 948.2591552734375), (549.9219970703125, 949.0299682617188), (546.7877197265625, 949.2583618164062), (543.0391235351562, 950.3264770507812), (540.4371337890625, 950.2576293945312), (536.7545166015625, 950.2576293945312), (535.3594360351562, 951.7049560546875), (531.5526123046875, 951.2568359375), (529.1304321289062, 952.3233032226562), (526.1114501953125, 952.2560424804688), (523.4823608398438, 952.2560424804688), (520.6408081054688, 953.2552490234375), (518.9091186523438, 953.9398193359375), (512.2884521484375, 954.2545166015625), (509.4122619628906, 955.2537231445312), (502.8785705566406, 956.2529296875), (500.0458679199219, 957.5115966796875), (492.73187255859375, 958.1127319335938), (486.8833312988281, 958.2513427734375), (482.8778991699219, 958.2513427734375), (477.3916015625, 959.8985595703125), (469.9708251953125, 960.2498168945312), (466.9854736328125, 961.3709106445312), (461.9608459472656, 961.2490234375), (427.1650085449219, 966.3256225585938), (419.2587890625, 967.2443237304688), (413.92510986328125, 969.742431640625), (405.7369384765625, 970.2420043945312), (401.79779052734375, 971.2412109375), (398.5235595703125, 972.1634521484375), (396.231201171875, 972.2404174804688), (393.95281982421875, 972.2404174804688), (391.412841796875, 972.2404174804688), (388.28509521484375, 972.2404174804688), (385.709228515625, 972.2404174804688), (383.4344177246094, 972.2404174804688), (381.0076904296875, 972.2404174804688), (380.4715881347656, 972.2404174804688), (379.47296142578125, 971.2412109375), (379.47296142578125, 970.2420043945312), (378.4743347167969, 970.2420043945312)], 0.031000)
        post_action(1.657457)
        perform_click_event("Tap", 232.676849, 1229.039795, 0.112000, "Activity")
        post_action(2.156198)
        perform_click_event("Tap", 399.445221, 1096.143677, 0.129000, "Activity")
        post_action(1.510512)
        perform_click_event("Tap", 520.277405, 1101.139771, 0.138000, "Activity")
        post_action(1.064974)
        perform_click_event("Tap", 400.443848, 1094.145142, 0.126000, "Activity")
        post_action(0.681077)
        perform_click_event("Tap", 514.285706, 1104.137451, 0.112000, "Activity")
        post_action(1.711107)
        perform_click_event("Tap", 183.744797, 1102.138916, 0.125000, "Activity")
        post_action(1.138130)
        perform_click_event("Tap", 73.897369, 1109.133545, 0.112000, "Activity")
        post_action(1.287134)
        perform_click_event("Tap", 370.485443, 1249.024170, 0.096000, "Activity")
        post_action(0.884852)
        perform_click_event("Tap", 464.355072, 715.441040, 0.142000, "Activity")
        post_action(1.229066)
        perform_swipe_event([(305.5755920410156, 996.2216796875), (335.5093994140625, 983.5496826171875), (331.53955078125, 985.2302856445312), (339.4731750488281, 983.7869262695312), (355.20849609375, 980.411376953125), (358.5020751953125, 979.2349853515625), (363.4951477050781, 978.2357788085938), (372.45098876953125, 975.914794921875), (378.32586669921875, 975.3123779296875), (382.9054260253906, 974.0204467773438), (388.46044921875, 974.2388916015625), (395.59027099609375, 973.2396850585938), (401.9324035644531, 972.2404174804688), (409.67999267578125, 971.4913330078125), (415.5017395019531, 971.2412109375), (418.1388854980469, 971.2412109375), (421.82763671875, 971.2412109375), (428.4688415527344, 971.2412109375), (429.42950439453125, 971.2412109375), (434.39666748046875, 971.2412109375), (436.6702880859375, 971.2412109375), (440.5489807128906, 971.2412109375), (444.9041442871094, 971.2412109375), (452.9137268066406, 971.2412109375), (458.74017333984375, 971.2412109375), (462.74981689453125, 971.2412109375), (471.22686767578125, 971.2412109375), (479.67657470703125, 971.2412109375), (485.5771179199219, 970.2420043945312), (494.1528015136719, 969.5327758789062), (501.0632019042969, 969.2427978515625), (503.0618896484375, 969.2427978515625), (508.7803955078125, 968.2435302734375), (512.0825805664062, 968.2435302734375), (515.5062866210938, 968.2435302734375), (518.7794189453125, 968.2435302734375), (521.7752685546875, 967.2443237304688), (522.274658203125, 967.2443237304688), (524.1356201171875, 967.2443237304688), (524.2718505859375, 967.2443237304688)], 0.033000)
        post_action(0.905198)
        perform_click_event("Tap", 335.533997, 1214.051514, 0.082000, "Activity")
        post_action(1.669122)
        perform_click_event("Tap", 367.489594, 1228.040649, 0.112000, "Activity")
        post_action(1.009206)
        perform_click_event("Tap", 234.674072, 1243.028931, 0.068000, "Activity")
        post_action(1.224566)
        perform_click_event("Tap", 238.668518, 1231.038208, 0.086000, "Activity")
        post_action(0.421822)
        perform_click_event("Tap", 514.285706, 1242.029663, 0.099000, "Activity")
        post_action(1.083683)
        perform_swipe_event([(594.1747436523438, 1112.131103515625), (533.5419311523438, 1123.7958984375), (499.62567138671875, 1129.341796875), (463.3564453125, 1134.114013671875), (450.9616394042969, 1136.9647216796875), (424.380126953125, 1143.3876953125), (416.7752380371094, 1145.2667236328125), (397.447998046875, 1151.1005859375), (389.956787109375, 1153.4742431640625), (368.44891357421875, 1158.7745361328125), (356.9983215332031, 1160.794189453125), (340.4934387207031, 1166.52685546875), (332.11669921875, 1168.0048828125), (325.9366760253906, 1169.9561767578125), (312.06658935546875, 1172.583984375), (300.0545349121094, 1174.082763671875), (289.7567138671875, 1176.291259765625), (285.8448486328125, 1176.0811767578125), (280.96173095703125, 1177.0804443359375), (275.2367248535156, 1177.0804443359375), (270.4979553222656, 1178.1112060546875), (263.6539001464844, 1178.07958984375), (251.0015106201172, 1176.63916015625), (241.48410034179688, 1177.0804443359375), (228.38409423828125, 1176.0811767578125), (221.86569213867188, 1176.0811767578125), (216.2368621826172, 1175.4659423828125), (208.08042907714844, 1175.0819091796875), (204.11268615722656, 1173.8817138671875), (201.42518615722656, 1174.082763671875), (200.72122192382812, 1174.082763671875), (201.71983337402344, 1174.082763671875)], 0.026000)
        post_action(1.744807)
        perform_click_event("Tap", 436.393921, 1107.135010, 0.112000, "Activity")
        post_action(1.720317)
        perform_swipe_event([(261.6366271972656, 1112.131103515625), (291.244384765625, 1109.7606201171875), (313.4261474609375, 1112.84521484375), (328.6787414550781, 1114.2327880859375), (361.9972229003906, 1119.125732421875), (378.382568359375, 1120.83203125), (418.31170654296875, 1122.123291015625), (437.7235412597656, 1122.123291015625), (473.3582458496094, 1120.3902587890625), (488.3763732910156, 1119.2044677734375), (500.5536193847656, 1119.125732421875), (525.769775390625, 1120.62451171875), (536.2552490234375, 1120.1248779296875), (556.4979858398438, 1122.1533203125), (563.3125610351562, 1122.123291015625), (578.1968994140625, 1123.6221923828125), (584.87158203125, 1123.12255859375), (597.1876220703125, 1123.12255859375), (605.135498046875, 1123.12255859375), (611.6819458007812, 1122.123291015625), (616.5679931640625, 1121.1241455078125), (620.0929565429688, 1121.1241455078125), (623.4165649414062, 1121.1241455078125), (625.631103515625, 1121.1241455078125), (626.13037109375, 1121.1241455078125), (624.895263671875, 1121.1241455078125)], 0.020000)
        post_action(0.386511)
        perform_click_event("Tap", 253.647720, 1107.135010, 0.097000, "Activity")
        post_action(1.342912)
        perform_click_event("Tap", 223.689331, 1106.135864, 0.085000, "Activity")
        post_action(1.014824)
        perform_click_event("Tap", 377.475739, 1126.120239, 0.097000, "Activity")
        post_action(1.140579)
        perform_click_event("Tap", 56.920944, 1255.019531, 0.099000, "Activity")
        post_action(1.335951)
        perform_click_event("Tap", 519.278809, 1182.076538, 0.138000, "Activity")
        post_action(4.671030)
        perform_click_event("Tap", 290.596405, 1243.028931, 0.070000, "Activity")
        post_action(1.909080)
        perform_click_event("Tap", 520.277405, 1046.182617, 0.112000, "Activity")
        post_action(1.272863)
        perform_swipe_event([(357.50347900390625, 970.2420043945312), (386.1867370605469, 967.6328125), (379.47296142578125, 968.2435302734375), (390.45770263671875, 966.2451171875), (409.43133544921875, 962.747802734375), (419.6393737792969, 961.5081176757812), (430.1995544433594, 961.0499267578125), (445.3438415527344, 960.2498168945312), (454.6456604003906, 960.2498168945312), (461.80908203125, 960.2498168945312), (472.0059814453125, 960.2498168945312), (479.64007568359375, 960.2498168945312), (487.2632751464844, 960.2498168945312), (493.0466613769531, 960.2498168945312), (500.41876220703125, 960.2498168945312), (506.4743347167969, 960.2498168945312), (514.0390625, 960.2498168945312), (521.7753295898438, 960.2498168945312), (528.1227416992188, 959.2506103515625), (535.8518676757812, 958.2513427734375), (543.7448120117188, 958.2513427734375), (550.6577758789062, 957.2521362304688), (558.3330688476562, 956.2529296875), (564.0745239257812, 955.2537231445312), (572.3543701171875, 953.2055053710938), (580.2987060546875, 952.2560424804688), (583.6893310546875, 950.7572021484375), (591.5625610351562, 949.0664672851562), (596.7089233398438, 947.9905395507812), (602.8936767578125, 947.2599487304688), (607.4445190429688, 946.1167602539062), (612.1497802734375, 943.7626342773438), (616.032958984375, 943.3187866210938), (619.32421875, 942.1717529296875), (622.7838745117188, 941.6155395507812), (623.6337890625, 940.7650146484375), (624.1331787109375, 940.2654418945312), (625.1317749023438, 940.2654418945312)], 0.033000)
        post_action(0.312464)
        perform_swipe_event([(379.47296142578125, 984.2310791015625), (403.6961975097656, 982.4356689453125), (416.9406433105469, 979.896728515625), (427.8162841796875, 978.3535766601562), (457.3833312988281, 974.236572265625), (472.38385009765625, 972.0919799804688), (488.8410339355469, 969.6558227539062), (502.2258605957031, 968.2435302734375), (513.0807495117188, 966.7963256835938), (522.7390747070312, 966.2451171875), (531.288330078125, 965.2393798828125), (541.9467163085938, 964.2467041015625), (549.5109252929688, 963.2474365234375), (556.0821533203125, 961.963623046875), (560.4871215820312, 962.2482299804688), (563.0868530273438, 961.2490234375), (565.6817016601562, 961.2490234375), (566.8541870117188, 961.2490234375), (567.2122192382812, 961.2490234375), (568.2108154296875, 961.2490234375), (569.20947265625, 961.2490234375), (570.2207641601562, 961.2490234375)], 0.033000)
        post_action(0.442747)
        perform_swipe_event([(397.447998046875, 985.2302856445312), (438.1556396484375, 980.8154907226562), (448.9669189453125, 979.57568359375), (457.9980773925781, 978.53125), (484.32733154296875, 974.738525390625), (501.5456848144531, 973.2396850585938), (511.1507568359375, 972.2404174804688), (520.9243774414062, 972.2404174804688), (523.9728393554688, 971.3409423828125), (526.6128540039062, 971.2412109375), (527.7669677734375, 971.2412109375), (528.765625, 971.2412109375), (530.2608032226562, 971.2412109375), (530.2635498046875, 971.2412109375), (531.2621459960938, 971.2412109375), (531.2621459960938, 969.7898559570312), (531.946044921875, 970.2420043945312), (532.2607421875, 970.2420043945312), (533.5286865234375, 970.2420043945312), (533.2593994140625, 970.2420043945312), (531.7614135742188, 970.2420043945312), (531.5537109375, 970.949462890625), (530.2387084960938, 971.2412109375), (527.9244384765625, 971.2412109375), (524.8067626953125, 971.2412109375), (519.27880859375, 971.2412109375), (506.712890625, 972.2404174804688), (500.32763671875, 973.2351684570312), (492.4981994628906, 974.107666015625), (483.0558166503906, 975.272216796875), (476.0873718261719, 976.273193359375), (467.2747497558594, 977.582275390625), (450.2101135253906, 981.0664672851562), (433.4664306640625, 983.2318725585938), (419.56134033203125, 986.5145874023438), (411.2305603027344, 988.0277099609375), (404.17059326171875, 990.315673828125), (398.44659423828125, 991.7252197265625), (392.6308288574219, 992.2247924804688), (389.39208984375, 993.2240600585938), (385.9639587402344, 993.2240600585938), (380.6693420410156, 994.2232666015625), (376.797607421875, 994.2232666015625), (372.0571594238281, 994.2232666015625), (368.64013671875, 993.2240600585938), (364.02655029296875, 992.2247924804688), (360.0992736816406, 991.5250244140625), (358.5020751953125, 991.2255859375), (355.008056640625, 990.2263793945312), (351.73785400390625, 989.2271728515625), (349.1734619140625, 989.2271728515625), (349.5145568847656, 989.2271728515625)], 0.030500)
        post_action(0.236449)
        perform_swipe_event([(531.2621459960938, 978.2357788085938), (511.7658996582031, 982.5709228515625), (497.45465087890625, 985.7531127929688), (483.5169982910156, 988.1965942382812), (467.5392150878906, 989.5445556640625), (443.9901123046875, 993.9556884765625), (420.5453796386719, 997.2047729492188), (402.688232421875, 1000.8023071289062), (389.4590759277344, 1003.7158203125), (371.002685546875, 1008.7059936523438), (360.1300048828125, 1009.8035278320312), (352.1530456542969, 1011.2099609375), (341.8128967285156, 1013.6361694335938), (337.34002685546875, 1014.2076416015625), (332.3783874511719, 1015.2068481445312), (329.154296875, 1016.5943603515625), (327.0457763671875, 1016.2061157226562), (326.5464782714844, 1017.4290771484375), (325.5478515625, 1017.205322265625), (325.5478515625, 1016.2061157226562), (326.5464782714844, 1016.2061157226562), (327.5455627441406, 1015.2068481445312), (330.2192687988281, 1015.2068481445312), (332.414306640625, 1013.77001953125), (339.8428039550781, 1013.2084350585938), (350.5475769042969, 1011.2030639648438), (364.8871154785156, 1009.6455688476562), (386.369140625, 1007.0623168945312), (398.9756774902344, 1006.2138671875), (410.7738037109375, 1004.3792724609375), (419.9438171386719, 1004.2154541015625), (425.9084777832031, 1003.2162475585938), (429.49920654296875, 1002.217041015625), (430.8870849609375, 1002.217041015625), (431.4008483886719, 1002.217041015625)], 0.033000)
        post_action(2.056780)
        perform_click_event("Tap", 290.596405, 1236.034302, 0.084000, "Activity")
        post_action(1.008026)
        perform_click_event("Tap", 531.262146, 723.434814, 0.181000, "Activity")
        post_action(2.096163)
        perform_swipe_event([(392.4549255371094, 969.2427978515625), (413.4258117675781, 960.2498168945312), (423.0740966796875, 958.1044311523438), (429.40362548828125, 957.2521362304688), (435.3952941894531, 955.2537231445312), (443.8648986816406, 953.7586059570312), (449.46185302734375, 952.4843139648438), (456.0135498046875, 950.9336547851562), (460.1447448730469, 949.8660278320312), (463.3451232910156, 950.2576293945312), (466.9584045410156, 950.2576293945312), (468.84881591796875, 950.2576293945312), (470.47540283203125, 950.2576293945312), (470.34674072265625, 950.2576293945312), (471.9494323730469, 950.2576293945312), (473.1778869628906, 950.2576293945312), (473.34259033203125, 950.2576293945312), (474.84051513671875, 950.2576293945312), (475.3398132324219, 950.2576293945312), (476.33843994140625, 950.2576293945312), (477.818115234375, 950.2576293945312), (478.3356628417969, 950.2576293945312)], 0.033000)
        post_action(2.141743)
        perform_swipe_event([(389.4591064453125, 947.2599487304688), (399.1754150390625, 946.7482299804688), (408.4327392578125, 946.2607421875), (419.2312316894531, 945.1802368164062), (418.41888427734375, 945.2615356445312), (420.7438659667969, 945.0030517578125), (434.39666748046875, 943.2630615234375), (451.472412109375, 940.4904174804688), (459.46319580078125, 938.8993530273438), (464.95550537109375, 938.2669677734375), (472.4149169921875, 937.2677612304688), (477.979736328125, 936.2685546875), (481.8307800292969, 936.2685546875), (484.51983642578125, 935.2693481445312), (485.60791015625, 935.2693481445312), (486.3245544433594, 935.2693481445312), (487.2314147949219, 935.2693481445312), (487.32318115234375, 935.2693481445312), (488.32177734375, 935.2693481445312), (489.3204040527344, 935.2693481445312), (490.79241943359375, 935.2693481445312), (490.3190002441406, 935.2693481445312), (491.81695556640625, 935.2693481445312), (491.317626953125, 935.2693481445312), (492.31622314453125, 935.2693481445312), (494.3134765625, 934.2700805664062), (501.0155029296875, 933.5592651367188), (508.01849365234375, 932.2716674804688), (511.5341796875, 931.2724609375), (513.6278076171875, 931.2724609375), (515.78369140625, 930.273193359375), (516.282958984375, 930.273193359375)], 0.033000)
        post_action(2.640261)
        perform_click_event("Tap", 279.611664, 1229.039795, 0.112000, "Activity")
        post_action(0.928894)
        perform_click_event("Tap", 521.276001, 728.430908, 0.167000, "Activity")
        post_action(1.392388)
        perform_swipe_event([(374.4798889160156, 958.2513427734375), (402.9830017089844, 951.4607543945312), (395.4507751464844, 953.2552490234375), (407.43414306640625, 950.2576293945312), (420.9253845214844, 947.4231567382812), (428.4049987792969, 946.2607421875), (437.2801513671875, 946.2607421875), (442.7812805175781, 946.2607421875), (448.37725830078125, 946.2607421875), (451.96270751953125, 945.2615356445312), (455.7409362792969, 945.2615356445312), (458.7885437011719, 945.2615356445312), (461.3881530761719, 945.2615356445312), (463.6889953613281, 945.2615356445312), (464.3550720214844, 945.2615356445312), (467.5278015136719, 946.437744140625), (469.6147766113281, 946.2607421875), (472.206298828125, 946.2607421875), (474.48150634765625, 945.2615356445312), (476.8377685546875, 945.2615356445312), (480.2946472167969, 945.2615356445312), (482.43939208984375, 944.2622680664062), (485.6947326660156, 944.2622680664062), (488.28082275390625, 944.2622680664062), (492.0995788574219, 942.871826171875), (495.08807373046875, 943.2630615234375), (498.2372131347656, 943.2630615234375), (500.804443359375, 943.2630615234375), (503.0847473144531, 943.2630615234375), (505.52777099609375, 943.2630615234375), (508.7933349609375, 943.2630615234375), (512.09912109375, 943.2630615234375), (514.6773071289062, 943.2630615234375), (516.6997680664062, 943.2630615234375), (518.2801513671875, 943.2630615234375), (519.7669067382812, 943.2630615234375), (520.2774047851562, 943.2630615234375), (521.2760009765625, 943.2630615234375), (522.274658203125, 943.2630615234375), (523.2732543945312, 943.2630615234375), (524.2718505859375, 943.2630615234375), (525.2704467773438, 943.2630615234375)], 0.033000)
        post_action(4.239527)
        perform_swipe_event([(537.2538452148438, 920.281005859375), (507.29541015625, 923.2786865234375), (517.2815551757812, 922.2794799804688), (509.4737548828125, 925.4044799804688), (500.3051452636719, 929.2739868164062), (491.6926574707031, 931.7362060546875), (493.3148498535156, 931.2724609375), (482.3301086425781, 934.2700805664062), (478.0523376464844, 934.2700805664062), (473.4365234375, 935.7219848632812), (468.2127685546875, 936.2685546875), (463.5477600097656, 937.2677612304688), (458.4470520019531, 939.2661743164062), (455.99383544921875, 940.2654418945312), (453.6240539550781, 941.2646484375), (451.4226989746094, 942.2142333984375), (449.87518310546875, 942.2638549804688), (450.3744812011719, 942.2638549804688), (454.0211486816406, 941.4386596679688), (457.587890625, 941.2646484375), (464.8543701171875, 939.765869140625), (477.8633117675781, 940.2654418945312), (486.6412658691406, 939.2661743164062), (496.2200012207031, 937.2677612304688), (501.2077941894531, 937.2677612304688), (505.99993896484375, 936.2685546875), (509.01776123046875, 936.2685546875), (512.1480712890625, 936.2685546875), (514.7850341796875, 936.2685546875), (517.7655639648438, 936.2685546875), (518.2801513671875, 936.2685546875), (519.27880859375, 936.2685546875), (520.2774047851562, 936.2685546875)], 0.033000)
        post_action(2.032667)
        perform_click_event("Tap", 444.382812, 1235.035156, 0.098000, "Activity")
        post_action(3.798676)
        perform_swipe_event([(440.38836669921875, 530.58544921875), (463.3564453125, 537.5800170898438), (475.92718505859375, 541.010498046875), (488.9845886230469, 544.9733276367188), (499.77838134765625, 547.0634155273438), (510.4637451171875, 551.15576171875), (521.080322265625, 554.28857421875), (532.0604248046875, 556.5250854492188), (541.2683715820312, 558.8184204101562), (548.238525390625, 560.0625), (554.482177734375, 561.561279296875), (558.6236572265625, 563.7593383789062), (562.2191772460938, 565.5581665039062)], 0.033000)
        post_action(0.754223)
        perform_swipe_event([(607.15673828125, 551.569091796875), (584.1886596679688, 559.5628662109375), (571.6397094726562, 567.2899169921875), (555.9948120117188, 576.097900390625), (530.2769775390625, 592.1950073242188), (491.317626953125, 618.5167846679688), (465.14654541015625, 638.9459838867188), (444.0979919433594, 656.0426025390625), (422.7746276855469, 677.1091918945312), (404.7983703613281, 695.0963745117188), (389.4590759277344, 710.4450073242188), (380.2567443847656, 718.3922729492188), (372.80767822265625, 726.1072387695312), (368.9307556152344, 729.4301147460938), (367.6770324707031, 731.2410278320312), (366.09149169921875, 732.8275146484375), (365.0509948730469, 734.8678588867188), (365.49237060546875, 735.4254760742188)], 0.034000)
        post_action(0.796166)
        perform_swipe_event([(524.2718505859375, 549.5706176757812), (509.429931640625, 583.7277221679688), (502.08038330078125, 601.3081665039062), (480.7743225097656, 644.6123046875), (469.10772705078125, 671.3305053710938), (455.43304443359375, 704.27490234375), (450.37451171875, 721.4364013671875), (444.83453369140625, 737.2931518554688), (441.1515197753906, 752.8263549804688), (440.38836669921875, 765.4019775390625), (438.3911437988281, 771.0706787109375), (436.9736328125, 777.231689453125), (437.39251708984375, 782.3125610351562), (436.3086853027344, 787.4701538085938), (436.3939208984375, 789.5905151367188), (436.3939208984375, 794.6766357421875), (436.3939208984375, 799.2012329101562), (436.3939208984375, 800.6143188476562), (436.3939208984375, 803.6934204101562), (436.3939208984375, 806.1079711914062), (435.4529113769531, 810.1939086914062), (435.3952941894531, 810.3668823242188)], 0.033000)
        post_action(0.447122)
        perform_swipe_event([(582.19140625, 553.5675048828125), (559.72265625, 583.544189453125), (552.7584228515625, 592.365234375), (525.7846069335938, 628.1561889648438), (501.43536376953125, 663.7837524414062), (485.08441162109375, 688.8419189453125), (471.34539794921875, 714.4418334960938), (460.0294494628906, 736.75341796875), (446.91253662109375, 759.047119140625), (439.08380126953125, 773.9676513671875), (433.64453125, 785.7691040039062), (428.44195556640625, 797.3031005859375), (426.40777587890625, 801.3739013671875), (425.4091491699219, 804.3411254882812), (425.4091491699219, 805.4636840820312), (424.4105529785156, 807.7574462890625), (424.4105529785156, 809.0393676757812), (423.41192626953125, 811.33447265625), (423.41192626953125, 812.6624145507812), (422.413330078125, 815.7243041992188), (422.413330078125, 817.3614501953125)], 0.033000)
        post_action(3.287371)
        perform_click_event("Tap", 42.940361, 1243.028931, 0.099000, "Activity")
        post_action(1.306141)
        perform_swipe_event([(571.2066650390625, 524.5901489257812), (555.4303588867188, 580.9376220703125), (547.6744384765625, 621.4476318359375), (541.4103393554688, 652.181640625), (525.0679931640625, 731.0121459960938), (498.6107482910156, 842.1795043945312)], 0.033000)
        post_action(0.015625)
        perform_swipe_event([(473.34259033203125, 971.2412109375), (475.4739074707031, 1004.0956420898438), (475.3398132324219, 1045.0794677734375), (475.3398132324219, 1063.020751953125), (476.33843994140625, 1102.78515625), (477.7610168457031, 1113.8001708984375), (481.12786865234375, 1134.482666015625), (481.33148193359375, 1142.983642578125), (482.3301086425781, 1156.48681640625), (483.3287353515625, 1167.088134765625), (485.44744873046875, 1173.32666015625), (485.3259582519531, 1174.307861328125), (485.3259582519531, 1174.082763671875), (485.3259582519531, 1175.51953125), (485.3259582519531, 1175.0819091796875)], 0.028000)
        post_action(0.453112)
        perform_swipe_event([(562.2191772460938, 328.7431640625), (562.2191772460938, 361.9237060546875), (559.2333374023438, 386.6275939941406), (543.211181640625, 470.80413818359375), (520.2774047851562, 564.059326171875), (510.7719421386719, 606.2307739257812), (494.68359375, 696.7750244140625), (489.7124328613281, 727.3621826171875), (477.972900390625, 818.3115234375), (474.7335510253906, 855.6171264648438), (472.3439636230469, 933.6806640625), (472.3439636230469, 955.9989013671875), (474.3085021972656, 1011.5217895507812), (476.4531555175781, 1051.131591796875), (480.6909484863281, 1091.336669921875), (484.22320556640625, 1121.446044921875), (486.71875, 1150.8380126953125), (490.0931701660156, 1177.59228515625), (492.2966003417969, 1195.9085693359375), (494.81280517578125, 1210.55419921875), (494.3134765625, 1214.051513671875), (496.4139404296875, 1221.35595703125), (497.5263671875, 1226.9110107421875), (497.3092956542969, 1228.6300048828125), (498.1371154785156, 1235.5216064453125), (499.70892333984375, 1244.2369384765625), (499.7471008300781, 1246.7906494140625), (500.3051452636719, 1253.6112060546875), (501.3037414550781, 1257.1455078125), (501.3037414550781, 1259.016357421875), (501.3037414550781, 1261.0147705078125)], 0.033000)
        post_action(0.399704)
        perform_swipe_event([(572.2052612304688, 510.6011047363281), (563.2704467773438, 527.587646484375), (553.8634033203125, 560.3480834960938), (539.336181640625, 619.8768920898438), (523.7833862304688, 684.08154296875), (511.8540344238281, 763.9871826171875), (504.9347229003906, 831.1283569335938), (501.1165466308594, 894.6126708984375), (501.3037414550781, 935.7689208984375), (501.3037414550781, 967.8599853515625), (501.3037414550781, 989.6447143554688), (501.3037414550781, 1028.9620361328125), (502.3023681640625, 1039.431884765625), (504.09130859375, 1056.1319580078125), (505.6448059082031, 1067.5543212890625), (506.29681396484375, 1068.16552734375)], 0.033000)
        post_action(0.661789)
        perform_key_event(4)
        post_action(0.000000)

    except Exception as e:
        print(e)
        traceback_str = ''.join(traceback.format_tb(e.__traceback__))
        print(traceback_str)
    clean_up()
    