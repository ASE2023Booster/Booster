# coding=utf8

import os
import sys
import time
import json
import frida
import argparse
import traceback
import uiautomator2 as u2
sys.path.append(os.path.abspath(os.getcwd()))
from script import util

frida_session = None
xml = None
view_hierarchy = None
save_path = None
action_count = 0
current_popup_window = None
curr_webview_address = None

d = u2.connect()
print(d.info)


def log(desc):
    global action_count
    print('[ReplayAction]-%d: ' % action_count, desc)


def error_handler(func):
    def wrapper(message, data):
        if message['type'] == 'error':
            print('[Func]: %s, [Error-msg]: %s' % (func.__name__, message))
            print('[Func]: %s, [Error-des]: %s' % (func.__name__, message['description']))
            print('[Func]: %s, [Error-sta]: %s' % (func.__name__, message['stack']))
            print('[Func]: %s, [Error-dat]: %s' % (func.__name__, data))
            return None
        else:
            return func(message, data)
    return wrapper


def preprocess_path():
    global save_path
    if save_path is None:
        return False
    if not os.path.exists(save_path):
        os.mkdir(save_path)
    else:
        for file in os.listdir(save_path):
            os.remove(os.path.join(save_path, file))
    return True


def post_action(custom_interval):
    global xml
    global d
    global action_count
    global save_path
    global view_hierarchy

    print('[ReplayTimeInterval]-%d: %s' % (action_count, json.dumps({'interval': custom_interval})))
    if action_count > 0:
        # time.sleep(1)
        if custom_interval > 0:
            time.sleep(custom_interval)
    xml = d.dump_hierarchy()
    xml = util.parse_xml(xml)
    screenshot_filename = os.path.join(save_path, '_'.join(['screenshot', str(action_count)]) + '.jpg')
    xml_filename = os.path.join(save_path, '_'.join(['ui', str(action_count)]) + '.xml')
    view_hierarchy_filename = os.path.join(save_path, '_'.join(['view_hierarchy', str(action_count)]) + '.xml')
    d.screenshot(screenshot_filename)
    util.save_xml(xml, xml_filename)
    view_hierarchy, lxml_view_hierarchy = util.dump_view_hierarchy(d, view_hierarchy_filename)
    action_count += 1


def set_text(rid, bounds, text):
    global xml
    view = util.find_view(rid, bounds, xml)
    if view is None:
        print('TextView ' + rid + ' does not exist')
    else:
        if len(rid) > 0:
            d(resourceId=rid, focused=True).set_text(text)
        else:
            d(focused=True).set_text(text)
        log('[set_text]-%s' % json.dumps({'rid': rid, 'text': text, 'bounds': bounds}))


def press_soft_keyboard(key_name):
    global xml
    index = util.find_soft_key(key_name, xml)
    if index is None:
        raise Exception('Key ' + key_name + ' does not exist')
    key_x, key_y = index[0], index[1]
    d.click(key_x, key_y)
    log('[press_key]-%s' % json.dumps({'key_name': key_name}))


def hide_soft_keyboard():
    global xml
    if util.check_soft_keyboard(xml):
        print('Hide soft keyboard')
        d.press('back')
        log('[hide_keyboard]')


def record_popup_window():
    global current_popup_window
    current_popup_window = util.get_current_window(d)
    log('[record_popup_window]-%s' % json.dumps({'window': current_popup_window}))


def close_popup_window():
    global current_popup_window
    if current_popup_window is not None:
        window = util.get_current_window(d)
        if window == current_popup_window:
            d.press('back')
            log('[hide_popup_window]-%s' % json.dumps({'window': current_popup_window}))
            current_popup_window = None


def clean_up():
    global frida_session
    print('Clean Up....')
    frida_session.detach()


def detect_webview():
    # Get WebView handle
    global frida_session
    instrument_script = frida_session.create_script(util.instrument_WebView())
    instrument_script.on('message', get_instrument_WebView_message)
    instrument_script.load()


@error_handler
def get_instrument_WebView_message(message, data):
    global curr_webview_address
    print('[WebView]: ', message)
    curr_webview_address = util.get_view_address(message['payload']['webview'])


def perform_click_event(tap_type, x, y, duration, view_type):
    global action_count
    global view_hierarchy
    global frida_session

    if view_type == 'Activity':
        candidates = util.find_component_candidates(view_hierarchy, x, y)
        # Instrument
        instrument_script = None
        code = util.instrument_view([candidate['classname'] for candidate in candidates], [candidate['address'] for candidate in candidates], action_count)
        instrument_script = frida_session.create_script(code)
        instrument_script.on('message', get_instrument_view_message)
        instrument_script.load()
        if tap_type == 'LongTap':
            d.long_click(x, y, duration)
        elif tap_type == 'Tap':
            d.long_click(x, y, duration)
        elif tap_type == 'DoubleTap':
            d.double_click(x, y, 0.1)

        # time.sleep(1)
        instrument_script.unload()
        log('[click]-%s' % json.dumps({'tap_type': tap_type, 'x': x, 'y': y, 'duration': duration, 'candidate': candidates, 'view_type': view_type}))

    else:
        # Dialog & PopupWindow
        # command `adb shell dumpsys activity top` fails to extract view hierarchy of Dialog & PopupWindow
        if tap_type == 'LongTap':
            d.long_click(x, y, duration)
        elif tap_type == 'Tap':
            d.long_click(x, y, duration)
        elif tap_type == 'DoubleTap':
            d.double_click(x, y, 0.1)
        log('[click]-%s' % json.dumps({'tap_type': tap_type, 'x': x, 'y': y, 'duration': duration, 'view_type': view_type}))


@error_handler
def get_instrument_view_message(message, data):
    print('[ReplayViewInstrumentation]: %s' % json.dumps(message))


def perform_swipe_event(pointers, duration=0.01):
    d.swipe_points(pointers, duration)
    log('[swipe]-%s' % json.dumps({'pointers': pointers, 'duration': duration}))


def perform_key_event(key_code):
    d.press(key_code)
    log('[press]-%s' % json.dumps({'key_code': key_code}))


def webview_set_text(input_selector, text, webview_classname, package_name):
    # Set Text
    global curr_webview_address
    code = util.webview_set_text(input_selector, text, webview_classname, curr_webview_address, package_name)
    instrument_script = frida_session.create_script(code)
    instrument_script.on('message', get_webview_set_text_message)
    instrument_script.load()


def webview_set_text_with_u2(text):
    d(focused=True).set_text(text)
    log('[webview_set_text]-%s' % json.dumps({'text': text}))


@error_handler
def get_webview_set_text_message(message, data):
    print('[WebViewSetText]: ', message)


def instrument_chrome_client():
    code = util.instrument_chrome_client()
    script = frida_session.create_script(code)
    script.on('message', get_instrument_chrome_client_message)
    script.load()


@error_handler
def get_instrument_chrome_client_message(message, data):
    print('[Console]: ', message)


if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='Argument Parser')
    parser.add_argument('--path', help='save path', required=True)
    parser.add_argument('--package', help='package name', required=True)
    parser.add_argument('--pid', help='pid name', required=True)
    args = parser.parse_args()
    
    save_path = args.path
    package_name = args.package
    pid = int(args.pid)

    if not preprocess_path():
        print('Save path not found')
        sys.exit()

    # Setup Dynamic instrument   
    all_devices = frida.enumerate_devices()
    device = frida.get_usb_device()

    # Attach
    frida_session = device.attach(pid)
    print(frida_session)

    try:
        detect_webview()
        # instrument_chrome_client()
        post_action(0)

        perform_click_event("Tap", 610.152588, 1088.149902, 0.055000, "Activity")
        post_action(1.099335)
        perform_swipe_event([(458.3634033203125, 1061.1708984375), (458.3634033203125, 1030.1407470703125), (457.3647766113281, 1004.2153930664062), (456.3661804199219, 968.8696899414062), (456.3661804199219, 942.2907104492188), (457.1953430175781, 905.66796875), (460.6008605957031, 870.3953857421875), (462.1485900878906, 850.616455078125), (468.9471435546875, 815.6185913085938), (473.2498474121094, 793.9060668945312), (477.8459167480469, 776.482421875), (486.0719299316406, 739.4342651367188), (497.35528564453125, 701.2679443359375), (507.615966796875, 662.5286254882812), (516.8630981445312, 634.970703125), (526.2785034179688, 602.4987182617188), (534.4669189453125, 575.6205444335938), (544.244140625, 536.0811767578125), (556.8494262695312, 496.432373046875), (563.0108642578125, 476.513671875), (569.5844116210938, 450.36566162109375), (575.47998046875, 426.27081298828125), (582.6907348632812, 403.68463134765625), (585.13427734375, 391.8530578613281), (586.3367309570312, 385.943115234375), (589.5828247070312, 376.5007629394531), (599.122314453125, 350.0791015625), (602.491455078125, 341.5245666503906), (604.1597290039062, 332.7481689453125), (610.0324096679688, 321.9892272949219), (612.1408081054688, 316.2754211425781), (617.1095581054688, 301.8642272949219), (619.1126098632812, 297.8222961425781), (620.406494140625, 291.4315490722656), (623.6337890625, 281.77984619140625), (623.895751953125, 276.7348327636719), (625.2120971679688, 271.46612548828125), (626.3240356445312, 265.40478515625), (627.1290283203125, 259.2605895996094), (627.1290283203125, 254.74261474609375), (626.13037109375, 253.8017120361328), (625.1282348632812, 253.8017120361328)], 0.033000)
        post_action(0.413323)
        perform_click_event("Tap", 252.649109, 707.447327, 0.084000, "Activity")
        post_action(2.644650)
        perform_swipe_event([(356.5048522949219, 611.522216796875), (363.4951477050781, 596.533935546875), (372.482666015625, 586.541748046875), (395.0438537597656, 560.96923828125), (415.1444091796875, 540.6738891601562), (429.12481689453125, 526.970458984375), (442.38555908203125, 513.5987548828125), (452.0819091796875, 503.89654541015625), (464.64166259765625, 491.32916259765625), (476.1379089355469, 481.7574768066406), (482.0706787109375, 475.51812744140625), (487.0858459472656, 471.1072692871094), (490.2841491699219, 468.66876220703125), (493.81414794921875, 466.13580322265625), (494.3134765625, 465.63623046875)], 0.033000)
        post_action(0.849378)
        perform_swipe_event([(465.35369873046875, 493.6143493652344), (433.1065368652344, 500.5286560058594), (406.82293701171875, 505.8787841796875), (378.1032409667969, 514.7217407226562), (346.9639587402344, 523.4424438476562), (321.1981201171875, 531.1366577148438), (302.3671569824219, 534.629638671875), (283.6060791015625, 538.07958984375), (268.537109375, 539.5784301757812), (257.4452819824219, 539.5784301757812), (246.6634521484375, 537.9140625), (234.29689025878906, 534.7896118164062), (211.7059783935547, 524.0905151367188), (195.7655792236328, 513.6174926757812), (173.8251495361328, 496.1678466796875), (161.23289489746094, 486.591064453125), (146.8270263671875, 476.315185546875), (133.39877319335938, 467.0245056152344), (120.86454010009766, 459.66033935546875), (113.00398254394531, 455.0850524902344), (107.85021209716797, 453.14599609375), (99.5821762084961, 450.5548095703125), (94.46118927001953, 449.6487121582031), (90.10274505615234, 447.6502685546875), (87.83726501464844, 447.6502685546875), (86.38002014160156, 446.1514587402344), (85.88072204589844, 446.65106201171875)], 0.033000)
        post_action(1.178505)
        perform_swipe_event([(90.87378692626953, 459.6408996582031), (113.61981964111328, 479.5557556152344), (110.75535583496094, 477.1020812988281), (124.250732421875, 487.2348937988281), (136.2847900390625, 496.5363464355469), (140.804443359375, 499.60968017578125), (146.79612731933594, 503.6065673828125), (151.7891845703125, 506.6042175292969), (156.28292846679688, 508.10302734375), (156.78225708007812, 508.6026611328125), (158.28018188476562, 510.1014709472656), (159.69740295410156, 510.6011047363281), (160.77670288085938, 510.6011047363281), (161.7753143310547, 510.6011047363281), (162.6780548095703, 511.6003112792969), (163.7725372314453, 511.6003112792969)], 0.033000)
        post_action(1.293555)
        perform_click_event("Tap", 508.294037, 1236.034302, 0.038000, "Activity")
        post_action(0.811321)
        perform_swipe_event([(593.1761474609375, 1107.135009765625), (562.6390991210938, 1109.890869140625), (546.239990234375, 1110.1326904296875), (517.4495239257812, 1111.1319580078125), (480.5273742675781, 1116.443115234375), (465.2068786621094, 1120.3638916015625), (420.2320251464844, 1132.8328857421875), (383.609130859375, 1142.3526611328125), (351.8773193359375, 1149.217529296875), (331.5819091796875, 1152.4693603515625), (313.3418884277344, 1155.7498779296875), (286.3752136230469, 1161.7286376953125), (274.7713317871094, 1163.802490234375), (265.1944274902344, 1166.0889892578125), (263.63385009765625, 1167.587890625)], 0.033000)
        post_action(1.229393)
        perform_click_event("Tap", 317.558960, 1101.139771, 0.086000, "Activity")
        post_action(1.190618)
        perform_click_event("Tap", 347.517334, 1245.027344, 0.100000, "Activity")
        post_action(0.786199)
        perform_click_event("Tap", 499.306519, 618.516785, 0.111000, "Activity")
        post_action(1.530032)
        perform_click_event("Tap", 500.305145, 624.512085, 0.126000, "Activity")
        post_action(1.275334)
        perform_swipe_event([(207.71151733398438, 767.4004516601562), (230.6796112060547, 760.4059448242188), (240.66574096679688, 758.407470703125), (267.32867431640625, 754.2940673828125), (320.8146057128906, 746.0404663085938), (336.1387634277344, 743.8179321289062), (351.0099792480469, 741.3379516601562), (371.39996337890625, 737.77099609375), (388.6357421875, 735.1905517578125), (396.6991271972656, 734.1138916015625), (403.2074890136719, 732.4277954101562), (414.4531555175781, 730.2236938476562), (422.91259765625, 727.9312744140625), (434.5650329589844, 726.390380859375), (441.9288635253906, 724.2532958984375), (451.4171447753906, 723.673583984375), (459.44488525390625, 722.407958984375), (466.7688293457031, 722.4356079101562), (472.0555725097656, 721.4364013671875), (475.3994445800781, 721.3767700195312), (478.9942626953125, 720.4371337890625), (480.83221435546875, 720.4371337890625), (481.33148193359375, 720.4371337890625), (482.3301086425781, 720.4371337890625), (483.3287353515625, 720.4371337890625), (483.3287353515625, 721.4364013671875), (483.3287353515625, 722.4356079101562), (481.598388671875, 722.4356079101562), (480.1328125, 724.6342163085938), (476.83770751953125, 726.93212890625), (474.8132629394531, 728.1947631835938), (471.2774353027344, 731.4625854492188), (465.53057861328125, 734.2492065429688), (456.2431640625, 739.5043334960938), (445.5695495605469, 744.6260375976562), (440.6578674316406, 748.1456298828125), (434.76507568359375, 752.0435791015625), (430.4022216796875, 753.9110107421875), (426.501708984375, 755.4098510742188), (423.9112548828125, 756.4090576171875), (423.41192626953125, 757.26806640625), (421.9140319824219, 757.4082641601562), (421.4147033691406, 757.4082641601562)], 0.033500)
        post_action(0.998945)
        perform_click_event("Tap", 363.495148, 1245.027344, 0.081000, "Activity")
        post_action(0.753547)
        perform_click_event("Tap", 483.328735, 714.441833, 0.069000, "Activity")
        post_action(1.135150)
        perform_swipe_event([(268.6269226074219, 906.2919311523438), (292.7344970703125, 904.4364013671875), (314.2542419433594, 900.6043701171875), (330.54095458984375, 897.798583984375), (350.1050109863281, 895.2266845703125), (364.6686706542969, 894.3013305664062), (379.5753479003906, 892.5270385742188), (390.7711486816406, 891.2409057617188), (402.94036865234375, 888.3060302734375), (414.0209045410156, 886.4085083007812), (422.61016845703125, 885.308349609375), (433.3980712890625, 882.810302734375), (440.1719055175781, 880.312255859375), (445.0924987792969, 879.3130493164062), (449.0926513671875, 878.5972290039062), (452.2911071777344, 878.3138427734375), (453.56964111328125, 878.3138427734375), (454.3689270019531, 878.3138427734375), (455.3675537109375, 878.3138427734375), (456.5091247558594, 878.3138427734375), (454.8939208984375, 878.3138427734375), (454.66558837890625, 879.3130493164062), (453.6313781738281, 880.051025390625), (448.77001953125, 882.61376953125), (443.63922119140625, 886.0523681640625), (434.4440612792969, 887.294921875), (426.54412841796875, 891.8788452148438), (421.8139953613281, 893.3688354492188), (413.3224792480469, 897.0750122070312), (403.5553283691406, 901.7376098632812), (389.4013977050781, 908.9130249023438), (376.17742919921875, 916.1509399414062), (367.5965576171875, 918.7554321289062), (358.3157043457031, 924.3711547851562), (352.0111083984375, 927.775146484375), (346.0640869140625, 930.7578735351562), (338.39495849609375, 934.6481323242188), (334.0346984863281, 936.0194091796875), (330.585693359375, 937.2677612304688), (325.5478515625, 939.7657470703125), (322.0493469238281, 940.2654418945312), (318.3492126464844, 942.4722900390625), (315.4471740722656, 944.2622680664062), (309.4608459472656, 947.3145751953125), (304.59136962890625, 949.7507934570312), (298.4993591308594, 953.2982177734375), (296.2377014160156, 954.2545166015625), (291.59503173828125, 956.7525634765625), (288.41375732421875, 958.4368896484375), (280.5558776855469, 959.9348754882812), (274.01385498046875, 963.14892578125), (264.6580810546875, 965.7391357421875), (258.2949523925781, 966.917724609375), (251.18275451660156, 968.3995361328125), (244.2309112548828, 970.71826171875), (238.38282775878906, 971.2412109375), (231.67657470703125, 972.2404174804688), (225.5396270751953, 973.6217651367188), (218.69773864746094, 975.2376098632812), (211.79754638671875, 976.539794921875), (204.21636962890625, 977.736083984375), (196.4529571533203, 978.2357788085938), (189.97296142578125, 979.4891967773438), (183.2174072265625, 980.0770263671875), (176.6269989013672, 980.2341918945312), (170.79823303222656, 980.2341918945312), (145.57521057128906, 980.2341918945312), (140.804443359375, 978.7353515625), (136.8078155517578, 979.2349853515625), (135.81137084960938, 979.2349853515625), (125.25226593017578, 975.713134765625), (114.76760864257812, 972.2161254882812), (105.02688598632812, 969.7855834960938), (100.2037353515625, 968.2435302734375), (96.85678100585938, 967.2443237304688), (94.36893463134766, 966.2451171875), (94.86824035644531, 965.2459106445312), (94.86824035644531, 964.2467041015625), (94.86824035644531, 963.2474365234375), (95.86685180664062, 962.2482299804688), (97.9638442993164, 962.2482299804688), (102.64105224609375, 959.8933715820312), (114.84050750732422, 957.751708984375), (137.58766174316406, 951.9005737304688), (159.78207397460938, 947.6588134765625), (184.69033813476562, 944.3674926757812), (208.73648071289062, 939.8972778320312), (243.66159057617188, 933.7705078125), (277.8629150390625, 929.2384643554688), (302.2015075683594, 927.1135864257812), (325.2311096191406, 925.5343627929688), (343.61138916015625, 924.266845703125), (358.0935363769531, 923.2786865234375), (367.8495178222656, 922.2794799804688), (374.534912109375, 921.2802734375), (380.4715576171875, 920.281005859375), (386.1456298828125, 918.4415283203125), (391.0419006347656, 918.2825927734375), (392.9542236328125, 918.2825927734375), (393.45355224609375, 918.2825927734375), (394.4521484375, 918.2825927734375), (395.4507751464844, 918.2825927734375), (394.4521484375, 918.2825927734375), (392.4549255371094, 919.2817993164062), (389.4591064453125, 919.2817993164062), (386.3934020996094, 919.9712524414062), (377.8553161621094, 922.4859619140625), (369.30255126953125, 923.2786865234375), (359.78955078125, 926.1800537109375), (352.7276916503906, 928.47021484375), (342.0249938964844, 930.7728271484375), (333.4369201660156, 933.2958374023438), (324.9477233886719, 935.4194946289062), (315.67669677734375, 938.7090454101562), (305.6822204589844, 941.2432861328125), (295.8559875488281, 945.1281127929688), (286.408447265625, 947.0585327148438), (277.68096923828125, 948.2591552734375), (271.1234436035156, 949.2583618164062), (266.06842041015625, 950.2576293945312), (257.6421813964844, 950.2576293945312), (255.6449432373047, 951.2568359375), (254.64633178710938, 951.2568359375), (252.80650329589844, 951.2568359375), (250.5349884033203, 951.2568359375), (249.65325927734375, 951.2568359375), (248.65464782714844, 951.2568359375), (247.15673828125, 951.2568359375), (246.6574249267578, 951.2568359375), (245.6588134765625, 951.2568359375)], 0.033000)
        post_action(0.924802)
        perform_click_event("Tap", 365.492371, 1238.032837, 0.098000, "Activity")
        post_action(1.583289)
        perform_click_event("Tap", 523.273254, 719.437927, 0.111000, "Activity")
        post_action(1.093024)
        perform_swipe_event([(290.5964050292969, 950.2576293945312), (314.67083740234375, 944.0122680664062), (331.20233154296875, 940.1127319335938), (345.1997375488281, 937.6542358398438), (357.50347900390625, 935.2693481445312), (376.24700927734375, 934.2700805664062), (379.6617736816406, 933.2708740234375), (379.47296142578125, 933.2708740234375), (380.4715881347656, 933.2708740234375), (381.4701843261719, 933.2708740234375), (384.1940612792969, 933.2708740234375), (385.23321533203125, 933.2708740234375), (387.7930603027344, 933.2708740234375), (388.9013671875, 933.2708740234375), (390.45770263671875, 932.2716674804688), (391.44683837890625, 932.2716674804688), (392.4549255371094, 932.2716674804688), (394.9514465332031, 932.2716674804688), (395.23309326171875, 931.2724609375), (395.4507751464844, 931.2724609375), (396.6760559082031, 931.2724609375), (396.4493713378906, 931.2724609375), (397.2554626464844, 931.2724609375), (397.447998046875, 931.2724609375), (396.4493713378906, 932.2716674804688), (395.4507751464844, 932.2716674804688), (394.4521484375, 932.2716674804688), (393.5970458984375, 933.2708740234375), (390.1540832519531, 933.2708740234375), (388.1056213378906, 934.2700805664062), (378.474365234375, 934.2700805664062), (376.1333312988281, 935.9409790039062), (373.32476806640625, 936.2685546875), (369.76239013671875, 937.9912719726562), (367.4959716796875, 938.2669677734375), (365.0528259277344, 939.7059936523438), (362.680419921875, 939.2661743164062), (360.49444580078125, 940.2703247070312), (359.00140380859375, 940.2654418945312), (357.58453369140625, 941.2646484375), (355.2388000488281, 941.2646484375), (353.6009826660156, 942.2638549804688), (352.7769470214844, 942.2638549804688), (352.5104064941406, 942.2638549804688), (351.5118103027344, 942.2638549804688), (351.5118103027344, 941.2646484375), (353.3831787109375, 940.2654418945312), (355.66290283203125, 939.1094360351562), (357.50347900390625, 938.759765625), (359.0013732910156, 938.2669677734375), (359.5007019042969, 937.2677612304688), (360.49932861328125, 937.2677612304688), (361.4979248046875, 936.2685546875), (362.4965515136719, 936.2685546875), (363.4951477050781, 936.2685546875), (364.4937744140625, 936.2685546875), (365.49237060546875, 936.2685546875), (366.4909973144531, 936.2685546875)], 0.033000)
        post_action(2.670108)
        perform_click_event("Tap", 44.937588, 1233.036743, 0.085000, "Activity")
        post_action(1.736245)
        perform_swipe_event([(536.2551879882812, 1082.154541015625), (530.35791015625, 1049.6995849609375), (526.7684326171875, 1016.7056884765625), (524.2718505859375, 970.6507568359375), (524.2718505859375, 954.4129638671875), (524.2718505859375, 927.3001098632812), (525.07421875, 908.469482421875), (527.7303466796875, 881.604736328125), (530.9977416992188, 862.3853149414062), (534.3638305664062, 847.9666748046875), (537.8794555664062, 834.2158813476562), (541.13427734375, 821.9287109375), (542.4492797851562, 816.5513916015625), (544.5371704101562, 808.4880981445312), (544.9735717773438, 804.180419921875), (546.1784057617188, 799.50146484375), (546.2413330078125, 796.9366455078125), (546.2413330078125, 796.3778076171875), (546.2413330078125, 795.3786010742188)], 0.033000)
        post_action(0.460576)
        perform_click_event("Tap", 565.214966, 452.646362, 0.099000, "Activity")
        post_action(2.467026)
        perform_click_event("Tap", 489.320404, 1097.142822, 0.086000, "Activity")
        post_action(1.338926)
        perform_click_event("Tap", 634.119263, 1112.131104, 0.099000, "Activity")
        post_action(0.579914)
        perform_swipe_event([(577.1983642578125, 1113.13037109375), (529.5407104492188, 1107.952880859375), (488.32177734375, 1106.1358642578125), (446.49151611328125, 1106.1358642578125), (411.470458984375, 1110.377197265625), (370.9906921386719, 1116.52685546875), (341.0140075683594, 1122.0537109375), (310.275634765625, 1127.93310546875), (283.9189453125, 1132.6944580078125), (258.7666015625, 1136.0914306640625), (232.1775360107422, 1139.6097412109375), (210.91004943847656, 1143.6658935546875), (188.78793334960938, 1148.590087890625), (171.2621307373047, 1151.600341796875), (154.62994384765625, 1154.9287109375), (139.70433044433594, 1156.44677734375), (134.01617431640625, 1159.4930419921875), (129.7903289794922, 1160.0936279296875), (127.4850082397461, 1160.0936279296875), (126.82386016845703, 1161.0928955078125)], 0.033000)
        post_action(0.347573)
        perform_swipe_event([(227.68377685546875, 1114.129638671875), (264.7694091796875, 1104.5089111328125), (307.8131103515625, 1096.430908203125), (358.767578125, 1091.93359375), (385.3173522949219, 1093.4051513671875), (403.0040283203125, 1096.570556640625), (420.86444091796875, 1100.7523193359375), (437.1824645996094, 1103.91064453125), (453.84521484375, 1106.516357421875), (467.8502197265625, 1107.634521484375), (478.8349609375, 1110.1328125), (489.22808837890625, 1111.5130615234375), (501.47613525390625, 1113.1495361328125), (511.77471923828125, 1113.13037109375), (519.4387817382812, 1114.2745361328125), (525.644287109375, 1114.129638671875), (531.8327026367188, 1114.129638671875), (536.2833862304688, 1114.129638671875), (541.2125244140625, 1114.129638671875), (545.1759033203125, 1112.819580078125), (548.5458984375, 1113.13037109375), (552.7142333984375, 1113.13037109375), (555.6351928710938, 1112.131103515625), (558.1806640625, 1112.131103515625), (560.1920776367188, 1112.131103515625), (560.221923828125, 1112.131103515625)], 0.017000)
        post_action(0.386910)
        perform_click_event("Tap", 338.529816, 1091.147583, 0.068000, "Activity")
        post_action(1.032736)
        perform_click_event("Tap", 289.597778, 1252.021851, 0.042000, "Activity")
        post_action(1.159578)
        perform_click_event("Tap", 486.324554, 638.501160, 0.086000, "Activity")
        post_action(0.924855)
        perform_swipe_event([(548.2385864257812, 827.3536376953125), (519.162841796875, 834.0831909179688), (475.33978271484375, 847.3380126953125), (453.2366943359375, 855.3818969726562), (436.3115234375, 860.482421875), (420.4217224121094, 865.9212646484375), (406.8200988769531, 870.49560546875), (392.4549560546875, 876.3153686523438), (376.98028564453125, 883.0078125), (365.0617370605469, 885.39453125), (355.0069274902344, 890.304443359375), (341.91729736328125, 894.1445922851562), (330.72900390625, 898.0231323242188), (319.7728576660156, 901.0526123046875), (312.7947998046875, 903.2943115234375), (306.57421875, 905.7923583984375), (301.8377685546875, 907.4530639648438), (295.4078063964844, 909.2896118164062), (289.01995849609375, 911.4807739257812), (281.2369689941406, 915.0758666992188), (276.5274353027344, 918.3710327148438), (269.1371765136719, 921.7762451171875), (262.8464660644531, 925.2066650390625), (257.4541320800781, 928.4629516601562), (249.15394592285156, 932.271728515625), (239.94769287109375, 934.1998901367188), (231.18585205078125, 936.6415405273438), (222.67640686035156, 940.0192260742188), (214.82241821289062, 941.2646484375), (204.71568298339844, 943.7626953125), (194.6763916015625, 944.2622680664062), (181.58897399902344, 945.2615356445312), (168.86680603027344, 946.2607421875), (157.61367797851562, 945.2615356445312), (149.612548828125, 945.2615356445312), (142.41683959960938, 945.2615356445312), (135.6461181640625, 945.2615356445312), (128.67877197265625, 945.2615356445312), (123.82801818847656, 945.2615356445312), (119.63125610351562, 945.2615356445312), (117.55008697509766, 945.2615356445312), (115.9092025756836, 945.2615356445312), (114.84049987792969, 945.2615356445312)], 0.033000)
        post_action(0.983910)
        perform_click_event("Tap", 30.957005, 1262.014038, 0.111000, "Activity")
        post_action(1.172690)
        perform_click_event("Tap", 223.689331, 622.513672, 0.099000, "Activity")
        post_action(1.783594)
        perform_swipe_event([(309.5700378417969, 830.3512573242188), (342.5918273925781, 820.1589965820312), (352.23406982421875, 818.400146484375), (360.1250305175781, 815.8209228515625), (374.2183532714844, 812.8173828125), (385.7108459472656, 811.3660888671875), (393.4320068359375, 809.0418090820312), (399.9445495605469, 808.3684692382812), (410.3233337402344, 805.1922607421875), (418.6039123535156, 803.0762939453125), (425.2212829589844, 801.4678955078125), (428.1783142089844, 801.3739013671875), (433.3980712890625, 800.3746948242188), (438.8144226074219, 799.37548828125), (440.4240417480469, 799.37548828125), (442.5566711425781, 799.37548828125), (444.4229431152344, 799.37548828125), (446.87933349609375, 799.37548828125), (447.378662109375, 799.37548828125), (449.8546142578125, 799.37548828125), (452.2333679199219, 799.37548828125), (454.43792724609375, 799.37548828125), (456.71051025390625, 799.37548828125), (460.01055908203125, 799.37548828125), (463.71331787109375, 799.37548828125), (466.9029235839844, 799.37548828125), (469.7054748535156, 800.0538940429688), (474.14788818359375, 800.3746948242188), (479.33428955078125, 800.3746948242188), (482.0069885253906, 801.3739013671875), (484.34490966796875, 801.3739013671875), (487.6134033203125, 802.3731689453125), (494.4790344238281, 802.3731689453125), (501.2728576660156, 802.3731689453125), (506.61944580078125, 802.3731689453125), (514.84130859375, 801.3739013671875), (525.2892456054688, 799.3707885742188), (535.4991455078125, 798.0657958984375), (545.24267578125, 794.8790283203125), (555.8200073242188, 792.2330322265625), (562.9873657226562, 790.1262817382812), (571.6102294921875, 786.683349609375), (580.7144775390625, 784.126953125), (584.4337768554688, 782.5582885742188), (591.4588623046875, 778.75146484375), (597.3875732421875, 775.2857055664062), (599.3676147460938, 774.2951049804688), (602.8181762695312, 772.3965454101562), (605.973388671875, 770.4905395507812), (607.15673828125, 769.0621948242188), (609.6533203125, 769.39892578125), (610.152587890625, 768.399658203125), (611.1511840820312, 768.399658203125), (610.152587890625, 768.399658203125), (601.386962890625, 771.785888671875), (585.5519409179688, 775.3131713867188), (558.2091674804688, 781.2255859375), (532.6937866210938, 786.1829833984375), (509.4490051269531, 790.3668823242188), (483.8280334472656, 795.378662109375), (459.6023864746094, 800.966796875), (442.785888671875, 804.7403564453125), (417.53253173828125, 811.0881958007812), (391.1662902832031, 816.0205688476562), (374.97015380859375, 819.5294189453125), (363.4951171875, 821.8579711914062), (359.5007019042969, 823.2987670898438), (358.39581298828125, 823.3567504882812), (357.50347900390625, 824.35595703125), (355.16046142578125, 825.028564453125), (353.7887878417969, 825.3551635742188), (351.2445983886719, 826.3544311523438), (350.1230163574219, 827.7440185546875), (347.75238037109375, 828.3528442382812), (346.51873779296875, 829.31005859375), (345.271240234375, 829.35205078125), (345.5201110839844, 829.35205078125)], 0.033000)
        post_action(0.546191)
        perform_click_event("Tap", 39.944523, 1247.025757, 0.068000, "Activity")
        post_action(1.093556)
        perform_swipe_event([(457.3647766113281, 1076.1593017578125), (461.75286865234375, 1041.2156982421875), (463.84161376953125, 1031.5079345703125), (466.2742614746094, 1018.6339111328125), (471.165283203125, 988.8994140625), (478.8630065917969, 953.7716674804688), (482.4546203613281, 932.5233154296875), (485.4556579589844, 913.4637451171875), (490.31903076171875, 875.8157958984375), (491.6183776855469, 863.8192138671875), (494.492919921875, 839.7266845703125), (496.9447326660156, 832.127685546875), (497.6871032714844, 823.7081909179688), (500.2137451171875, 808.7342529296875), (501.3037414550781, 800.7672729492188), (501.3037414550781, 799.8751220703125), (502.80169677734375, 797.3770751953125), (502.3023681640625, 795.3344116210938), (502.3023681640625, 794.1807861328125), (502.3023681640625, 794.1515502929688), (502.3023681640625, 793.3801879882812)], 0.017000)
        post_action(0.332232)
        perform_click_event("Tap", 228.682388, 676.471497, 0.085000, "Activity")
        post_action(1.913545)
        perform_click_event("Tap", 372.482666, 1105.136597, 0.112000, "Activity")
        post_action(1.147273)
        perform_swipe_event([(606.1581420898438, 1122.123291015625), (583.3050537109375, 1131.47802734375), (561.4652709960938, 1139.5362548828125), (542.4196166992188, 1146.664306640625), (520.9154052734375, 1150.13427734375), (492.0151672363281, 1154.7615966796875), (472.0890808105469, 1157.013427734375), (460.0546875, 1158.351318359375), (446.05194091796875, 1159.094482421875), (439.5505065917969, 1160.0936279296875), (435.5991516113281, 1161.02490234375), (433.5048522949219, 1161.0928955078125), (424.4105529785156, 1162.591796875), (420.4161071777344, 1163.5908203125), (415.08740234375, 1164.8126220703125), (399.04315185546875, 1168.48779296875), (392.1976623535156, 1169.2662353515625), (381.6828918457031, 1171.625732421875), (362.29217529296875, 1174.6832275390625), (352.1851806640625, 1176.121826171875), (338.8809509277344, 1177.445068359375), (329.265380859375, 1177.0804443359375), (305.8654479980469, 1179.078857421875), (295.3655090332031, 1180.1029052734375), (274.9453125, 1180.0780029296875), (263.7280578613281, 1180.0780029296875), (249.4378204345703, 1180.0780029296875), (234.80111694335938, 1180.0780029296875), (231.29612731933594, 1180.0780029296875), (227.77931213378906, 1180.0780029296875), (227.68377685546875, 1180.0780029296875)], 0.021500)
        post_action(0.388063)
        perform_click_event("Tap", 425.409149, 1097.142822, 0.080000, "Activity")
        post_action(0.649237)
        perform_click_event("Tap", 272.621368, 1249.024170, 0.085000, "Activity")
        post_action(1.146098)
        perform_click_event("Tap", 489.320404, 717.439514, 0.082000, "Activity")
        post_action(1.115599)
        perform_swipe_event([(554.230224609375, 830.3512573242188), (526.2576293945312, 841.0140380859375), (523.9111328125, 843.02197265625), (521.2760009765625, 844.34033203125), (498.8499755859375, 853.3863525390625), (478.67901611328125, 860.657958984375), (460.97808837890625, 866.9148559570312), (445.73626708984375, 871.45263671875), (403.0523376464844, 884.9862060546875), (387.6656188964844, 890.7020874023438), (365.12615966796875, 900.9794921875), (350.3687438964844, 907.9485473632812), (340.4643859863281, 911.3193359375), (329.04302978515625, 917.283447265625), (323.3644104003906, 920.555419921875), (311.74273681640625, 926.6058349609375), (297.60906982421875, 932.5897827148438), (285.09649658203125, 937.6058349609375), (275.5881042480469, 943.6155395507812), (255.361572265625, 954.0159301757812), (250.00631713867188, 957.5751342773438), (244.8779296875, 958.2513427734375), (237.6394500732422, 962.2634887695312), (231.8595428466797, 964.2467041015625), (229.68099975585938, 966.2451171875), (228.68238830566406, 966.2451171875), (228.68238830566406, 967.7227783203125), (227.68377685546875, 967.2443237304688), (228.6180419921875, 966.3095092773438), (228.68238830566406, 966.2451171875)], 0.034000)
        post_action(0.542599)
        perform_click_event("Tap", 44.937588, 1269.008545, 0.124000, "Activity")
        post_action(2.439549)
        perform_click_event("Tap", 544.244141, 806.369995, 0.111000, "Activity")
        post_action(2.109977)
        perform_click_event("Tap", 345.520111, 1099.141235, 0.070000, "Activity")
        post_action(1.686304)
        perform_click_event("Tap", 216.699036, 1118.126465, 0.068000, "Activity")
        post_action(1.578304)
        perform_click_event("Tap", 277.614441, 1249.024170, 0.086000, "Activity")
        post_action(1.808300)
        perform_click_event("Tap", 483.328735, 1081.155396, 0.080000, "Activity")
        post_action(1.121074)
        perform_click_event("Tap", 44.937588, 1243.028931, 0.111000, "Activity")
        post_action(1.501697)
        perform_swipe_event([(529.264892578125, 658.4855346679688), (509.5563049316406, 695.92822265625), (500.3381042480469, 719.0974731445312), (488.9375915527344, 752.1513061523438), (480.9823303222656, 787.3661499023438), (470.3127746582031, 827.041015625), (467.3023986816406, 848.7255249023438), (466.352294921875, 866.65771484375), (463.58135986328125, 888.72900390625), (463.3564453125, 896.7811889648438), (462.35784912109375, 913.1737060546875), (462.35784912109375, 928.66552734375), (463.4098815917969, 943.5839233398438), (463.3564453125, 955.1159057617188), (463.3564453125, 958.4916381835938), (464.3550720214844, 962.1286010742188), (464.3550720214844, 966.880859375), (464.3550720214844, 968.88037109375), (464.3550720214844, 972.8508911132812), (465.35369873046875, 974.448974609375), (465.35369873046875, 975.2380981445312), (465.35369873046875, 976.2373046875)], 0.033000)
        post_action(0.480060)
        perform_click_event("Tap", 560.221924, 636.502747, 0.128000, "Activity")
        post_action(3.747272)
        perform_click_event("Tap", 281.608887, 1113.130371, 0.125000, "Activity")
        post_action(3.285158)
        perform_click_event("Tap", 57.919556, 1134.114014, 0.137000, "Activity")
        post_action(2.000867)
        perform_swipe_event([(549.2371826171875, 809.36767578125), (511.5101623535156, 817.8915405273438), (495.0581970214844, 824.89306640625), (477.3370361328125, 833.3489990234375), (461.01593017578125, 839.491455078125), (451.5891418457031, 844.653564453125), (441.1307067871094, 849.8404541015625), (435.3243713378906, 852.3577880859375), (432.93878173828125, 853.3333129882812), (429.530517578125, 855.331787109375), (426.3407897949219, 856.3309936523438), (423.9112548828125, 857.3302001953125), (422.5167236328125, 858.3294067382812), (421.4147033691406, 859.3286743164062), (420.4161071777344, 859.745849609375), (419.487548828125, 860.327880859375), (418.4730224609375, 860.327880859375), (417.1886901855469, 860.327880859375), (415.92230224609375, 860.327880859375), (416.421630859375, 861.3270874023438), (416.421630859375, 859.9632568359375), (417.9195556640625, 860.327880859375), (420.48797607421875, 860.327880859375), (427.56304931640625, 858.943359375), (435.3952941894531, 856.83056640625), (446.3768615722656, 854.0835571289062), (453.3671875, 852.0020751953125), (461.2325744628906, 850.3990478515625), (463.2636413574219, 849.3828735351562), (466.8515930175781, 849.33642578125), (468.8326721191406, 849.33642578125), (469.34814453125, 849.33642578125), (470.34674072265625, 849.33642578125), (472.4259338378906, 849.33642578125), (473.34259033203125, 849.33642578125), (474.3412170410156, 848.4422607421875), (475.3398132324219, 848.3372192382812), (473.5353088378906, 849.1436157226562), (471.4111022949219, 850.3027954101562), (465.2278747558594, 852.7091674804688), (459.6194152832031, 855.07421875), (455.4493103027344, 857.289306640625), (451.87237548828125, 858.8289794921875), (451.37310791015625, 859.8148803710938), (450.3744812011719, 859.3286743164062), (450.3744812011719, 860.327880859375), (448.8765869140625, 860.327880859375), (449.3758850097656, 860.327880859375)], 0.033000)
        post_action(0.774768)
        perform_click_event("Tap", 42.940361, 1245.027344, 0.111000, "Activity")
        post_action(1.533249)
        perform_swipe_event([(481.33148193359375, 604.5277099609375), (470.1579284667969, 635.2737426757812), (460.707763671875, 672.08447265625), (457.86407470703125, 692.4590454101562), (452.7191467285156, 745.5181884765625), (450.06732177734375, 777.2376708984375), (447.90118408203125, 828.8402709960938), (449.3758850097656, 852.279541015625), (450.3744812011719, 885.2024536132812), (451.70147705078125, 898.5861206054688), (455.14752197265625, 922.95703125), (458.843017578125, 949.9663696289062), (460.3677978515625, 970.3641357421875), (464.9577331542969, 1007.0411376953125), (464.92401123046875, 1025.3145751953125), (466.17608642578125, 1062.993408203125), (467.50067138671875, 1086.8502197265625), (470.5986633300781, 1124.158203125), (472.9707946777344, 1142.894775390625), (475.18914794921875, 1166.5799560546875), (477.7684326171875, 1185.665771484375), (479.7998046875, 1198.8604736328125), (481.33148193359375, 1206.2513427734375), (483.73419189453125, 1213.270263671875), (488.7242431640625, 1220.1512451171875), (491.13543701171875, 1225.5863037109375), (493.3148498535156, 1229.039794921875)], 0.033000)
        post_action(0.602968)
        perform_swipe_event([(493.3148498535156, 462.6385498046875), (483.8125915527344, 491.839111328125), (474.8524475097656, 525.5415649414062), (463.04638671875, 567.8743286132812), (450.24761962890625, 621.7314453125), (438.8885803222656, 687.1015625), (427.9973449707031, 759.129638671875), (417.5708923339844, 808.614013671875), (411.60009765625, 847.5496215820312), (412.42718505859375, 873.2450561523438), (412.42718505859375, 886.0717163085938), (413.3946838378906, 896.9563598632812), (414.9237060546875, 921.7799072265625), (418.003662109375, 940.60205078125), (420.6756896972656, 959.0702514648438), (423.6485900878906, 973.9500122070312), (427.1156311035156, 987.5005493164062), (431.2794189453125, 1001.4136962890625), (432.8749694824219, 1008.640625), (435.4903259277344, 1019.67919921875), (437.8180236816406, 1031.32470703125), (439.0581359863281, 1037.529052734375), (439.3897399902344, 1039.1881103515625)], 0.033000)
        post_action(0.731842)
        perform_key_event(4)
        post_action(0.000000)

    except Exception as e:
        print(e)
        traceback_str = ''.join(traceback.format_tb(e.__traceback__))
        print(traceback_str)
    clean_up()
    