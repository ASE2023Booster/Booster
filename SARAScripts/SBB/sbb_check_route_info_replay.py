# coding=utf8

import os
import sys
import time
import json
import frida
import argparse
import traceback
import uiautomator2 as u2
sys.path.append(os.path.abspath(os.getcwd()))
from script import util

frida_session = None
xml = None
view_hierarchy = None
save_path = None
action_count = 0
current_popup_window = None
curr_webview_address = None

d = u2.connect()
print(d.info)


def log(desc):
    global action_count
    print('[ReplayAction]-%d: ' % action_count, desc)


def error_handler(func):
    def wrapper(message, data):
        if message['type'] == 'error':
            print('[Func]: %s, [Error-msg]: %s' % (func.__name__, message))
            print('[Func]: %s, [Error-des]: %s' % (func.__name__, message['description']))
            print('[Func]: %s, [Error-sta]: %s' % (func.__name__, message['stack']))
            print('[Func]: %s, [Error-dat]: %s' % (func.__name__, data))
            return None
        else:
            return func(message, data)
    return wrapper


def preprocess_path():
    global save_path
    if save_path is None:
        return False
    if not os.path.exists(save_path):
        os.mkdir(save_path)
    else:
        for file in os.listdir(save_path):
            os.remove(os.path.join(save_path, file))
    return True


def post_action(custom_interval):
    global xml
    global d
    global action_count
    global save_path
    global view_hierarchy

    print('[ReplayTimeInterval]-%d: %s' % (action_count, json.dumps({'interval': custom_interval})))
    if action_count > 0:
        # time.sleep(1)
        if custom_interval > 0:
            time.sleep(custom_interval)
    xml = d.dump_hierarchy()
    xml = util.parse_xml(xml)
    screenshot_filename = os.path.join(save_path, '_'.join(['screenshot', str(action_count)]) + '.jpg')
    xml_filename = os.path.join(save_path, '_'.join(['ui', str(action_count)]) + '.xml')
    view_hierarchy_filename = os.path.join(save_path, '_'.join(['view_hierarchy', str(action_count)]) + '.xml')
    d.screenshot(screenshot_filename)
    util.save_xml(xml, xml_filename)
    view_hierarchy, lxml_view_hierarchy = util.dump_view_hierarchy(d, view_hierarchy_filename)
    action_count += 1


def set_text(rid, bounds, text):
    global xml
    view = util.find_view(rid, bounds, xml)
    if view is None:
        print('TextView ' + rid + ' does not exist')
        focused = d(focused=True)
        if focused.count > 0:
            d(focused=True).set_text(text)
        else:
            d.shell('input text "%s"' % text)
        log('[set_text]-%s' % json.dumps({'rid': rid, 'text': text, 'bounds': bounds}))
    else:
        if len(rid) > 0:
            d(resourceId=rid, focused=True).set_text(text)
        else:
            d(focused=True).set_text(text)
        log('[set_text]-%s' % json.dumps({'rid': rid, 'text': text, 'bounds': bounds}))


def press_soft_keyboard(key_name):
    global xml
    index = util.find_soft_key(key_name, xml)
    if index is None:
        raise Exception('Key ' + key_name + ' does not exist')
    key_x, key_y = index[0], index[1]
    d.click(key_x, key_y)
    log('[press_key]-%s' % json.dumps({'key_name': key_name}))


def hide_soft_keyboard():
    global xml
    if util.check_soft_keyboard(xml):
        print('Hide soft keyboard')
        d.press('back')
        log('[hide_keyboard]')


def record_popup_window():
    global current_popup_window
    current_popup_window = util.get_current_window(d)
    log('[record_popup_window]-%s' % json.dumps({'window': current_popup_window}))


def close_popup_window():
    global current_popup_window
    if current_popup_window is not None:
        window = util.get_current_window(d)
        if window == current_popup_window:
            d.press('back')
            log('[hide_popup_window]-%s' % json.dumps({'window': current_popup_window}))
            current_popup_window = None


def clean_up():
    global frida_session
    print('Clean Up....')
    frida_session.detach()


def detect_webview():
    # Get WebView handle
    global frida_session
    instrument_script = frida_session.create_script(util.instrument_WebView())
    instrument_script.on('message', get_instrument_WebView_message)
    instrument_script.load()


@error_handler
def get_instrument_WebView_message(message, data):
    global curr_webview_address
    print('[WebView]: ', message)
    curr_webview_address = util.get_view_address(message['payload']['webview'])


def perform_click_event(tap_type, x, y, duration, view_type):
    global action_count
    global view_hierarchy
    global frida_session

    if view_type == 'Activity':
        candidates = util.find_component_candidates(view_hierarchy, x, y)
        # Instrument
        instrument_script = None
        code = util.instrument_view([candidate['classname'] for candidate in candidates], [candidate['address'] for candidate in candidates], action_count)
        instrument_script = frida_session.create_script(code)
        instrument_script.on('message', get_instrument_view_message)
        instrument_script.load()
        if tap_type == 'LongTap':
            d.long_click(x, y, duration)
        elif tap_type == 'Tap':
            d.long_click(x, y, duration)
        elif tap_type == 'DoubleTap':
            d.double_click(x, y, 0.1)

        # time.sleep(1)
        instrument_script.unload()
        log('[click]-%s' % json.dumps({'tap_type': tap_type, 'x': x, 'y': y, 'duration': duration, 'candidate': candidates, 'view_type': view_type}))

    else:
        # Dialog & PopupWindow
        # command `adb shell dumpsys activity top` fails to extract view hierarchy of Dialog & PopupWindow
        if tap_type == 'LongTap':
            d.long_click(x, y, duration)
        elif tap_type == 'Tap':
            d.long_click(x, y, duration)
        elif tap_type == 'DoubleTap':
            d.double_click(x, y, 0.1)
        log('[click]-%s' % json.dumps({'tap_type': tap_type, 'x': x, 'y': y, 'duration': duration, 'view_type': view_type}))


@error_handler
def get_instrument_view_message(message, data):
    print('[ReplayViewInstrumentation]: %s' % json.dumps(message))


def perform_swipe_event(pointers, duration=0.01):
    d.swipe_points(pointers, duration)
    log('[swipe]-%s' % json.dumps({'pointers': pointers, 'duration': duration}))


def perform_key_event(key_code):
    d.press(key_code)
    log('[press]-%s' % json.dumps({'key_code': key_code}))


def webview_set_text(input_selector, text, webview_classname, package_name):
    # Set Text
    global curr_webview_address
    code = util.webview_set_text(input_selector, text, webview_classname, curr_webview_address, package_name)
    instrument_script = frida_session.create_script(code)
    instrument_script.on('message', get_webview_set_text_message)
    instrument_script.load()


def webview_set_text_with_u2(text):
    d(focused=True).set_text(text)
    log('[webview_set_text]-%s' % json.dumps({'text': text}))


@error_handler
def get_webview_set_text_message(message, data):
    print('[WebViewSetText]: ', message)


def instrument_chrome_client():
    code = util.instrument_chrome_client()
    script = frida_session.create_script(code)
    script.on('message', get_instrument_chrome_client_message)
    script.load()


@error_handler
def get_instrument_chrome_client_message(message, data):
    print('[Console]: ', message)


if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='Argument Parser')
    parser.add_argument('--path', help='save path', required=True)
    parser.add_argument('--package', help='package name', required=True)
    parser.add_argument('--pid', help='pid name', required=True)
    args = parser.parse_args()
    
    save_path = args.path
    package_name = args.package
    pid = int(args.pid)

    if not preprocess_path():
        print('Save path not found')
        sys.exit()

    # Setup Dynamic instrument   
    all_devices = frida.enumerate_devices()
    device = frida.get_usb_device()

    # Attach
    frida_session = device.attach(pid)
    print(frida_session)

    try:
        detect_webview()
        # instrument_chrome_client()
        post_action(0)

        perform_click_event("Tap", 123.828018, 320.749420, 0.055000, "Activity")
        post_action(8.427472)
        perform_click_event("Tap", 385.464630, 220.827484, 0.095000, "Activity")
        post_action(2.432120)
        set_text("ch.sbb.mobile.android.b2c:id/text", "[0,192][720,244]", "metalli")
        post_action(0.769608)
        press_soft_keyboard("next")
        post_action(3.248983)
        perform_click_event("Tap", 171.761444, 454.644806, 0.085000, "Activity")
        post_action(1.622181)
        perform_click_event("Tap", 94.868240, 325.745514, 0.099000, "Activity")
        post_action(1.064070)
        set_text("ch.sbb.mobile.android.b2c:id/text", "[0,296][720,348]", "victor")
        post_action(0.540294)
        press_soft_keyboard("next")
        post_action(2.271585)
        perform_click_event("Tap", 172.760056, 567.556580, 0.055000, "Activity")
        post_action(5.745839)
        perform_swipe_event([(488.32177734375, 960.2498168945312), (481.33148193359375, 937.2677612304688), (479.3342590332031, 911.43310546875), (481.2176818847656, 885.7896728515625), (487.5715026855469, 848.0940551757812), (494.93341064453125, 817.843505859375), (502.7113342285156, 786.8836059570312), (511.284423828125, 758.4238891601562), (520.3109130859375, 729.3295288085938), (532.5829467773438, 690.4926147460938), (538.8897705078125, 675.5574951171875), (542.2503662109375, 665.4661865234375), (543.2454833984375, 659.4848022460938), (546.050048828125, 654.8714599609375), (548.5067749023438, 648.9559326171875), (550.866943359375, 644.8641357421875), (552.0968017578125, 642.6343994140625), (553.6869506835938, 640.0440063476562), (553.2316284179688, 640.4996337890625)], 0.033000)
        post_action(0.220669)
        perform_click_event("Tap", 479.334259, 774.395020, 0.082000, "Activity")
        post_action(1.536679)
        perform_click_event("Tap", 650.097107, 358.719757, 0.085000, "Activity")
        post_action(0.986140)
        perform_click_event("Tap", 640.110962, 352.724426, 0.085000, "Activity")
        post_action(0.868936)
        perform_click_event("Tap", 672.066589, 562.560486, 0.099000, "Activity")
        post_action(1.054339)
        perform_click_event("Tap", 688.044373, 539.578430, 0.069000, "Activity")
        post_action(0.793767)
        perform_swipe_event([(468.3495178222656, 867.3223876953125), (472.7959289550781, 839.5337524414062), (488.140380859375, 769.1647338867188), (504.3340148925781, 706.5859375), (508.5589599609375, 691.487060546875), (512.695556640625, 675.8416748046875), (524.1892700195312, 647.525634765625), (533.4964599609375, 621.8021850585938), (542.5201416015625, 600.134765625), (555.5028076171875, 572.072998046875), (564.6704711914062, 548.9343872070312), (578.5537109375, 519.05859375), (581.4833374023438, 514.0166015625), (583.0764770507812, 510.71466064453125), (583.1900024414062, 509.6954345703125), (584.1886596679688, 507.10382080078125), (585.6865234375, 507.6034240722656), (585.187255859375, 507.6034240722656), (586.1858520507812, 507.6034240722656)], 0.033000)
        post_action(0.716388)
        perform_click_event("Tap", 667.073547, 467.634674, 0.111000, "Activity")
        post_action(3.872419)
        perform_swipe_event([(585.187255859375, 544.5745239257812), (577.1983642578125, 579.5472412109375), (568.8516845703125, 621.0975341796875), (565.493408203125, 643.9876708984375), (562.3623657226562, 667.7614135742188), (562.008544921875, 681.5767822265625), (558.2247314453125, 705.948486328125), (556.1785278320312, 730.9192504882812), (552.7417602539062, 764.30859375), (548.2385864257812, 810.2416381835938), (546.826904296875, 829.0743408203125), (546.2413330078125, 858.8192749023438), (543.9857788085938, 878.3485107421875), (542.5617065429688, 885.4168090820312), (541.0223388671875, 902.6522827148438), (539.9476318359375, 913.4962158203125), (539.5232543945312, 921.18994140625), (538.25244140625, 930.971435546875), (537.2538452148438, 938.7666015625), (536.2551879882812, 946.4772338867188), (536.2551879882812, 950.4647827148438), (536.2551879882812, 954.6514282226562), (535.256591796875, 958.0358276367188), (535.256591796875, 961.3721923828125), (534.2579956054688, 963.7470703125), (534.2579956054688, 964.2467041015625), (534.2579956054688, 965.2459106445312), (534.2579956054688, 964.2467041015625), (534.2579956054688, 962.2482299804688), (536.14892578125, 952.89404296875), (543.692138671875, 918.4933471679688), (547.225830078125, 894.1666259765625), (558.8876953125, 837.1944580078125), (564.6476440429688, 795.9230346679688), (570.2081298828125, 757.9078369140625), (581.4602661132812, 699.168212890625), (584.7728881835938, 672.989013671875), (592.6768798828125, 630.0078125), (604.3154907226562, 581.9824829101562), (615.8954467773438, 534.279541015625), (622.7390747070312, 502.5924377441406), (630.1447143554688, 465.5665588378906), (638.0204467773438, 435.73114013671875), (644.964599609375, 418.2362365722656), (655.3844604492188, 386.1669006347656), (660.6972045898438, 366.40814208984375), (664.5964965820312, 342.8747863769531), (666.7886352539062, 322.746337890625), (667.0735473632812, 316.4422607421875), (669.0707397460938, 303.2961120605469), (669.0707397460938, 294.44512939453125), (670.2197265625, 283.0257263183594), (670.0693359375, 279.2343444824219), (670.0693359375, 268.9231872558594), (672.0665893554688, 261.8262023925781), (672.0665893554688, 259.1430969238281), (672.0665893554688, 255.0112762451172), (674.0842895507812, 251.79306030273438), (674.0638427734375, 251.80328369140625)], 0.033000)
        post_action(0.465449)
        perform_swipe_event([(459.36199951171875, 1043.18505859375), (464.6748962402344, 1009.9591064453125), (469.0802307128906, 985.14892578125), (474.926025390625, 950.3292846679688), (482.4445495605469, 917.4532470703125), (501.3037414550781, 843.8406982421875), (513.4150390625, 792.9193725585938), (516.8177490234375, 776.8938598632812), (526.26904296875, 737.9235229492188), (531.4085083007812, 718.4212036132812), (542.3817749023438, 682.0347900390625), (550.4019775390625, 652.5466918945312), (560.2764892578125, 621.7611694335938), (566.4425659179688, 602.379150390625), (574.2881469726562, 578.262451171875), (587.1845092773438, 545.5737915039062)], 0.033000)
        post_action(0.131281)
        perform_swipe_event([(606.1581420898438, 425.6674499511719), (599.1172485351562, 445.0415954589844), (590.6817626953125, 473.9533386230469), (584.4215698242188, 494.5639343261719), (573.2011108398438, 539.9222412109375), (559.5233154296875, 606.4440307617188), (554.5932006835938, 630.6900024414062), (544.43115234375, 686.2305908203125), (541.0082397460938, 707.3833618164062), (533.368896484375, 758.0463256835938), (530.2195434570312, 777.3090209960938), (523.6671142578125, 818.20556640625), (521.2969970703125, 836.1889038085938), (514.3659057617188, 870.9182739257812), (511.19598388671875, 889.962890625), (506.70416259765625, 922.4239501953125), (501.7132263183594, 956.0877685546875), (500.9759826660156, 967.8543701171875), (498.466064453125, 994.6393432617188), (497.4248352050781, 1005.0579223632812), (494.8255920410156, 1025.096435546875), (493.8119812011719, 1029.70654296875), (492.3336486816406, 1041.11669921875), (491.317626953125, 1046.446044921875), (491.317626953125, 1047.181884765625)], 0.033000)
        post_action(0.416187)
        perform_swipe_event([(603.1622924804688, 301.7642517089844), (588.8756713867188, 336.2729187011719), (581.50927734375, 361.3453674316406), (557.946533203125, 430.4713439941406), (538.6089477539062, 492.5353088378906), (530.755859375, 520.452392578125), (519.9529418945312, 568.8425903320312), (514.65087890625, 594.5487060546875), (507.53424072265625, 633.0704956054688), (505.0016784667969, 651.5696411132812), (501.53839111328125, 677.1786499023438), (501.3037414550781, 689.8080444335938), (498.80718994140625, 709.9453125), (497.6627502441406, 713.3807983398438), (496.17578125, 721.9763793945312), (494.8565368652344, 730.254150390625), (494.3134765625, 734.1570434570312), (493.3148498535156, 737.5408935546875), (493.3148498535156, 738.423095703125), (493.3148498535156, 739.4223022460938), (493.3148498535156, 738.423095703125), (493.3148498535156, 732.5599365234375), (496.5397644042969, 719.6349487304688), (500.6940002441406, 698.2021484375), (502.04278564453125, 687.3223266601562), (510.3168029785156, 654.6427001953125), (518.7404174804688, 625.76318359375), (532.0494995117188, 582.1445922851562), (543.5791015625, 549.8349609375), (548.323486328125, 536.8467407226562), (557.2848510742188, 516.4788208007812), (563.6871337890625, 499.1999816894531), (566.8411865234375, 494.5662841796875), (570.0015258789062, 488.0323486328125), (570.2080688476562, 484.5512390136719), (571.2066650390625, 483.6221618652344)], 0.033000)
        post_action(0.794706)
        perform_click_event("Tap", 55.922333, 120.905540, 0.111000, "Activity")
        post_action(3.734357)
        perform_swipe_event([(436.3939208984375, 945.2615356445312), (439.0273132324219, 900.1558837890625), (444.5292053222656, 866.58984375), (448.6769714355469, 842.3079223632812), (456.3586120605469, 807.3994750976562), (464.8543701171875, 766.4012451171875), (474.50567626953125, 727.981201171875), (480.9305725097656, 704.295166015625), (489.4781799316406, 662.85009765625), (500.3706359863281, 612.446044921875), (510.7789611816406, 566.5062255859375), (535.9218139648438, 466.19378662109375), (550.3589477539062, 422.1496276855469), (561.0631713867188, 393.8757019042969), (565.919677734375, 382.363525390625), (569.8988037109375, 370.6396484375), (577.1521606445312, 358.1305236816406), (583.1415405273438, 343.97393798828125), (586.0779418945312, 340.84173583984375), (590.1802978515625, 334.73846435546875), (590.1802978515625, 333.157470703125), (591.178955078125, 331.7408142089844), (591.9705810546875, 330.7416076660156), (592.1775512695312, 330.7416076660156), (593.1761474609375, 330.7416076660156)], 0.033000)
        post_action(0.486343)
        perform_swipe_event([(426.40777587890625, 997.220947265625), (426.40777587890625, 973.502197265625), (431.1968688964844, 941.0924072265625), (438.4755859375, 900.4159545898438), (448.2547302246094, 857.7960815429688), (456.0223083496094, 829.8328247070312), (469.34814453125, 785.3864135742188), (476.22210693359375, 765.7510986328125), (488.5267639160156, 732.53515625), (493.4259033203125, 718.327392578125), (505.3449401855469, 678.3296508789062), (517.8125, 643.0797729492188), (522.8978881835938, 624.827392578125), (534.538818359375, 598.0578002929688), (540.854736328125, 584.4302368164062), (546.3782348632812, 571.2109375), (550.3865966796875, 564.6405639648438), (553.231689453125, 558.0640869140625), (553.2316284179688, 556.6699829101562), (554.230224609375, 556.565185546875), (555.1548461914062, 556.565185546875), (555.2288818359375, 556.565185546875), (555.2288818359375, 555.5659790039062)], 0.029000)
        post_action(0.425222)
        perform_swipe_event([(412.42718505859375, 1011.2099609375), (412.42718505859375, 990.3550415039062), (416.421630859375, 960.7493896484375), (425.7015686035156, 910.0018310546875), (432.8039855957031, 882.8248901367188), (444.88214111328125, 829.8516845703125), (450.1944580078125, 812.7778930664062), (461.7087097167969, 773.1710815429688), (464.4892272949219, 763.9553833007812), (469.34814453125, 749.9140625), (477.540771484375, 732.6182250976562), (482.9532775878906, 715.7567138671875), (496.14801025390625, 684.6886596679688), (499.5940246582031, 672.2891235351562), (511.9399108886719, 637.40966796875), (517.0143432617188, 622.316650390625), (522.1766967773438, 603.146484375), (527.2529296875, 590.0796508789062), (543.1539306640625, 553.7965087890625), (552.6902465820312, 532.602783203125), (562.9356689453125, 507.98876953125), (566.712890625, 496.1123962402344), (571.32958984375, 486.37384033203125), (579.4608154296875, 470.16778564453125), (583.3950805664062, 459.4267578125), (585.187255859375, 452.146728515625), (593.7781372070312, 434.4549255371094), (597.4039306640625, 426.1219482421875), (601.4353637695312, 420.2655944824219), (603.9119262695312, 412.4258728027344), (608.1553955078125, 402.6853942871094), (610.0188598632812, 398.9561462402344), (612.1497802734375, 394.06939697265625), (613.423095703125, 393.4176025390625), (613.1484375, 393.6924133300781)], 0.017000)
        post_action(0.284132)
        perform_click_event("Tap", 600.166443, 345.729889, 0.111000, "Activity")
        post_action(4.916981)
        perform_swipe_event([(572.2052612304688, 507.6034240722656), (556.0623168945312, 546.9861450195312), (521.8602905273438, 659.973876953125), (509.66998291015625, 704.2493896484375), (503.54180908203125, 726.7088012695312), (501.0191345214844, 736.5645751953125), (497.309326171875, 755.4098510742188), (491.3880920410156, 777.0753784179688), (487.9395751953125, 787.5328979492188), (480.86505126953125, 806.2824096679688), (479.8975830078125, 814.3893432617188), (475.356201171875, 829.3029174804688), (472.6921691894531, 837.2999267578125), (470.9585876464844, 846.2754516601562), (468.5448303222656, 851.5523681640625), (465.3416442871094, 860.3760986328125), (462.7249450683594, 864.2733154296875), (460.85992431640625, 872.3184814453125), (460.3606262207031, 875.7608642578125), (458.0547180175781, 880.9299926757812), (458.3634033203125, 881.5800170898438), (455.86688232421875, 884.8087158203125), (455.3675537109375, 885.308349609375)], 0.032000)
        post_action(0.900950)
        perform_swipe_event([(628.1276245117188, 391.6940002441406), (616.122314453125, 416.811279296875), (578.9035034179688, 511.9259033203125), (542.4876098632812, 619.6722412109375), (529.2178344726562, 670.7872314453125), (520.1195068359375, 707.4656982421875), (508.6977233886719, 757.2861938476562), (503.5325012207031, 780.8465576171875), (498.30792236328125, 814.8634033203125), (487.74871826171875, 851.056640625), (481.830810546875, 869.3208618164062), (477.7562255859375, 886.8380126953125), (474.01849365234375, 904.5555419921875), (471.5428161621094, 910.6953125), (468.4908752441406, 924.4284057617188), (467.3149108886719, 930.4533081054688), (465.00286865234375, 941.021484375), (463.75616455078125, 947.2586059570312), (461.49725341796875, 957.5607299804688), (460.3606262207031, 966.4908447265625), (460.3606262207031, 970.9182739257812), (460.3606262207031, 974.135498046875), (460.1939392089844, 973.9053344726562), (459.36199951171875, 972.2404174804688)], 0.033000)
        post_action(0.315308)
        perform_swipe_event([(615.1456298828125, 384.699462890625), (594.1747436523438, 425.66741943359375), (579.1266479492188, 467.00469970703125), (561.28662109375, 521.7052001953125), (554.243896484375, 541.3952026367188), (540.4237670898438, 585.1389770507812), (532.3488159179688, 617.1355590820312), (528.5084838867188, 632.0310668945312), (522.8832397460938, 654.1240844726562), (517.3558959960938, 676.2731323242188), (512.754638671875, 693.3246459960938), (508.2940673828125, 708.9461059570312), (505.2003173828125, 718.8305053710938), (504.2995910644531, 723.8809204101562), (502.4980163574219, 730.84130859375), (501.3037414550781, 734.610107421875), (501.3037414550781, 736.92431640625), (500.3855285644531, 737.4238891601562), (500.3051452636719, 737.4238891601562), (500.3051452636719, 738.423095703125), (499.3065185546875, 739.32421875), (499.3065185546875, 739.4223022460938), (499.3065185546875, 738.423095703125), (499.3065185546875, 737.4785766601562), (499.3065185546875, 737.4238891601562), (500.804443359375, 734.42626953125), (501.3037414550781, 729.599609375), (505.4232482910156, 713.0048217773438), (508.9356994628906, 704.9498901367188), (513.287109375, 683.9656982421875), (518.3784790039062, 669.9559326171875), (524.3882446289062, 647.10595703125), (527.0074462890625, 635.1765747070312), (532.084228515625, 620.6338500976562), (535.8020629882812, 610.581787109375), (541.2969360351562, 598.4351196289062), (543.7447509765625, 587.541015625), (547.0494384765625, 580.119140625), (548.5056762695312, 576.01513671875), (549.8576049804688, 573.3095703125), (551.0868530273438, 570.7019653320312), (552.2330322265625, 568.1233520507812), (553.2316284179688, 567.5565795898438)], 0.033000)
        post_action(0.605268)
        perform_swipe_event([(443.3841857910156, 921.2802734375), (446.437744140625, 900.910888671875), (453.86962890625, 868.8212280273438), (457.27294921875, 857.6058349609375), (460.3606262207031, 839.7515869140625), (463.62548828125, 825.7383422851562), (467.2160339355469, 814.903564453125), (470.49957275390625, 809.0618286132812), (472.84326171875, 803.3723754882812), (473.00140380859375, 802.7145385742188), (473.34259033203125, 802.3731689453125), (473.34259033203125, 807.762939453125), (470.9380187988281, 816.2899780273438), (466.4073791503906, 841.03955078125), (462.49884033203125, 858.0510864257812), (459.98553466796875, 880.4439086914062), (456.7475891113281, 893.5831909179688), (453.37530517578125, 909.2597045898438), (452.07232666015625, 914.4847412109375), (449.87518310546875, 919.2817993164062), (450.3744812011719, 919.2817993164062), (450.3744812011719, 919.91259765625), (451.21405029296875, 920.281005859375), (451.37310791015625, 919.2817993164062)], 0.032000)
        post_action(0.464978)
        perform_click_event("Tap", 647.101257, 307.759552, 0.099000, "Activity")
        post_action(1.056821)
        perform_click_event("Tap", 641.109558, 303.762695, 0.112000, "Activity")
        post_action(1.069794)
        perform_click_event("Tap", 46.934814, 110.913345, 0.123000, "Activity")
        post_action(0.932496)
        perform_swipe_event([(577.1983642578125, 520.59326171875), (571.6755981445312, 554.2798461914062), (567.748046875, 575.404052734375), (559.7811279296875, 624.092041015625), (551.2383422851562, 669.950927734375), (546.4728393554688, 695.1819458007812), (542.1300048828125, 720.0811157226562), (540.7490234375, 744.9180908203125), (538.3785400390625, 768.2633056640625), (535.9429321289062, 787.8856201171875), (535.256591796875, 804.332275390625), (535.256591796875, 810.8054809570312), (535.256591796875, 824.3673706054688), (534.2579956054688, 835.347412109375), (533.546142578125, 840.9074096679688), (532.0718383789062, 852.2798461914062), (532.2607421875, 856.0288696289062), (531.5116577148438, 864.3253173828125), (531.2621459960938, 872.4641723632812), (531.2621459960938, 879.7465209960938), (530.2635498046875, 888.727783203125), (530.2635498046875, 896.4004516601562), (531.2621459960938, 905.0889892578125), (531.2621459960938, 911.859619140625), (531.2621459960938, 914.6553955078125), (531.2621459960938, 919.8495483398438), (531.2621459960938, 922.6514892578125), (530.3580932617188, 926.087158203125), (530.2635498046875, 927.4412841796875), (530.2635498046875, 929.7735595703125), (530.2635498046875, 929.9419555664062), (530.2635498046875, 931.4302368164062), (530.2635498046875, 931.2724609375), (530.2635498046875, 931.9808349609375), (530.2635498046875, 932.2716674804688), (529.264892578125, 933.2708740234375)], 0.033000)
        post_action(0.463834)
        perform_swipe_event([(599.1678466796875, 389.695556640625), (584.7437744140625, 390.5445251464844), (556.517578125, 397.70098876953125), (519.6414794921875, 406.4205627441406), (482.7150573730469, 416.328369140625), (438.89044189453125, 425.1678466796875), (420.4161071777344, 429.6643371582031), (371.9031066894531, 439.7669677734375), (346.75732421875, 444.336669921875), (300.58251953125, 449.64874267578125), (280.9003601074219, 449.3807678222656), (249.3992919921875, 449.6487121582031), (233.45541381835938, 449.6487121582031), (215.22088623046875, 450.6479187011719), (205.72918701171875, 452.5014953613281), (194.60546875, 454.7068786621094), (189.3661346435547, 455.9864501953125), (184.74342346191406, 458.1420593261719), (183.56845092773438, 457.6424560546875), (182.4426727294922, 457.6424560546875), (180.74896240234375, 457.6424560546875), (179.87850952148438, 458.5134582519531), (178.75173950195312, 458.6416931152344), (178.75173950195312, 457.142822265625), (178.75173950195312, 457.6424560546875), (180.87696838378906, 457.6424560546875), (183.6838836669922, 457.6424560546875), (195.64071655273438, 455.91571044921875), (209.43113708496094, 453.6883239746094), (258.0805358886719, 448.3625793457031), (276.24285888671875, 446.8882141113281), (321.2668151855469, 442.6900329589844), (335.7016906738281, 441.6429748535156), (365.49237060546875, 439.15692138671875), (378.9736328125, 438.15765380859375), (415.58056640625, 435.505615234375), (444.9146423339844, 432.15771484375), (483.3638000488281, 428.8161315917969), (507.548583984375, 425.5282897949219), (519.27880859375, 424.668212890625), (527.1135864257812, 424.668212890625), (537.74560546875, 424.668212890625), (550.719482421875, 423.66900634765625), (562.0142211914062, 422.6697998046875), (569.4164428710938, 421.6705627441406), (576.546142578125, 421.6705627441406), (580.1605834960938, 420.6713562011719), (582.690673828125, 420.6713562011719), (583.9501953125, 420.6713562011719), (588.6262817382812, 419.45037841796875), (593.1761474609375, 419.672119140625), (595.9761962890625, 418.67291259765625), (598.247314453125, 417.6346435546875), (600.6390380859375, 417.6737060546875), (600.1664428710938, 417.6737060546875)], 0.033000)
        post_action(0.500170)
        perform_swipe_event([(516.282958984375, 284.77752685546875), (509.440185546875, 317.6427001953125), (509.96484375, 320.6911315917969), (506.8162841796875, 340.09295654296875), (501.40594482421875, 371.992919921875), (496.3106994628906, 453.25445556640625), (495.31207275390625, 478.70220947265625), (494.3134765625, 491.9610290527344), (493.3148498535156, 512.9171142578125), (493.3148498535156, 522.7355346679688), (493.3148498535156, 539.7733154296875), (492.7926025390625, 546.1881103515625), (492.31622314453125, 559.662109375), (493.33575439453125, 564.66357421875), (493.3148498535156, 573.5518798828125), (493.3148498535156, 577.548828125), (492.31622314453125, 581.0048828125), (492.31622314453125, 589.3760986328125), (492.31622314453125, 592.2669067382812), (492.31622314453125, 597.1658325195312), (491.317626953125, 601.8638305664062), (491.317626953125, 604.4173583984375), (490.3190002441406, 608.0010986328125), (490.3190002441406, 611.6089477539062), (490.3190002441406, 613.6766967773438), (490.3190002441406, 617.0180053710938), (489.3204040527344, 622.3250732421875), (489.3204040527344, 627.223388671875), (487.99932861328125, 629.1542358398438), (488.32177734375, 633.3291625976562), (487.32318115234375, 637.887451171875), (486.3245544433594, 642.498046875), (485.3259582519531, 648.5164184570312), (484.32733154296875, 652.6806030273438), (484.32733154296875, 656.1947631835938), (484.32733154296875, 658.4517211914062), (484.32733154296875, 658.985107421875), (484.32733154296875, 659.4848022460938), (484.32733154296875, 660.4840087890625), (484.32733154296875, 662.4615478515625), (484.32733154296875, 663.7415161132812), (484.32733154296875, 665.2384643554688), (484.32733154296875, 665.979736328125), (484.32733154296875, 666.4793090820312), (484.32733154296875, 667.478515625), (484.32733154296875, 668.4777221679688), (484.32733154296875, 669.4769897460938), (484.32733154296875, 671.9547119140625), (484.32733154296875, 673.3334350585938), (484.32733154296875, 674.5062866210938), (484.32733154296875, 676.80615234375), (484.32733154296875, 677.9703369140625), (484.32733154296875, 679.110107421875), (484.32733154296875, 681.6353149414062), (484.32733154296875, 682.7608032226562), (484.32733154296875, 687.7791137695312), (484.32733154296875, 689.3128662109375), (483.45135498046875, 691.2144165039062), (483.3287353515625, 694.9346313476562), (483.3287353515625, 697.455078125), (483.3287353515625, 698.0662841796875), (483.3287353515625, 699.4535522460938), (483.3287353515625, 700.4527587890625), (482.6466369628906, 702.134521484375), (482.3301086425781, 704.3901977539062), (482.3301086425781, 705.7179565429688), (481.33148193359375, 707.2011108398438), (481.33148193359375, 707.4473266601562), (481.33148193359375, 708.446533203125), (481.33148193359375, 710.1885375976562), (481.33148193359375, 711.9437255859375), (481.33148193359375, 712.4434204101562), (480.5295104980469, 717.0460205078125), (480.3328857421875, 719.5053100585938), (477.8614807128906, 724.3837280273438), (478.3356628417969, 725.514892578125), (477.30731201171875, 728.4606323242188), (477.3370361328125, 729.4649047851562), (477.3370361328125, 730.4293212890625), (477.3370361328125, 731.4285888671875), (477.3370361328125, 732.4277954101562), (476.33843994140625, 733.427001953125), (476.33843994140625, 734.4262084960938), (476.33843994140625, 735.4254760742188), (476.33843994140625, 736.4246826171875), (476.33843994140625, 737.4238891601562)], 0.030000)
        post_action(0.667359)
        perform_swipe_event([(626.13037109375, 423.66900634765625), (583.409423828125, 427.6476135253906), (559.5836181640625, 431.6026611328125), (541.684814453125, 433.6726379394531), (515.876220703125, 437.1870422363281), (485.35003662109375, 439.98760986328125), (473.6951904296875, 442.0419006347656), (444.5846252441406, 445.4825744628906), (419.3434143066406, 448.65625), (386.96258544921875, 449.6487121582031), (345.572265625, 451.4677429199219), (298.11895751953125, 449.3612060546875), (262.9508972167969, 445.3608703613281), (247.45066833496094, 442.9530029296875), (223.303466796875, 442.6541748046875), (211.68092346191406, 442.6541748046875), (196.46998596191406, 442.6541748046875), (189.8426055908203, 442.6541748046875), (175.904541015625, 442.6541748046875), (166.5309295654297, 442.6541748046875), (148.06686401367188, 441.65496826171875), (126.45065307617188, 440.6557312011719), (117.56742095947266, 440.6557312011719), (102.22189331054688, 440.6557312011719), (91.03301239013672, 440.6557312011719), (80.88766479492188, 440.6557312011719), (76.53208923339844, 441.65496826171875), (67.47723388671875, 442.6541748046875), (61.22737121582031, 442.6541748046875), (58.69353103637695, 443.26617431640625), (55.06809997558594, 443.65338134765625), (54.9237174987793, 443.65338134765625), (50.92926788330078, 443.65338134765625), (51.927879333496094, 445.1378479003906), (49.9306526184082, 444.6526184082031)], 0.033000)
        post_action(3.351836)
        perform_swipe_event([(572.2052612304688, 762.4043579101562), (541.0537109375, 767.072509765625), (513.786376953125, 773.395751953125), (496.8839416503906, 774.39501953125), (479.111572265625, 776.837646484375), (468.84881591796875, 777.3926391601562), (460.9444274902344, 778.3919067382812), (450.0467224121094, 779.722900390625), (441.294189453125, 779.39111328125), (433.65655517578125, 780.3903198242188), (424.90985107421875, 780.3903198242188), (419.0646057128906, 781.3895263671875), (411.9732971191406, 781.3895263671875), (410.1469421386719, 781.3895263671875), (404.0135803222656, 781.3895263671875), (401.9443664550781, 781.3895263671875), (399.1451721191406, 781.3895263671875), (397.0949401855469, 781.3895263671875), (395.66815185546875, 781.3895263671875), (395.4507751464844, 781.3895263671875), (400.9431457519531, 780.3903198242188), (409.8197326660156, 779.39111328125), (431.53277587890625, 777.1558837890625), (440.30596923828125, 776.1805419921875), (462.561279296875, 776.3934326171875), (473.5340881347656, 775.5584716796875), (501.8523864746094, 775.3942260742188), (512.2885131835938, 773.8953857421875), (536.3082275390625, 772.4911499023438), (546.8703002929688, 771.327392578125), (555.8372192382812, 770.3305053710938), (577.6976928710938, 767.9000244140625), (586.6813354492188, 766.7139892578125), (604.4110107421875, 765.4020385742188), (613.7982788085938, 764.07177734375), (625.6939697265625, 762.7633056640625), (634.7322998046875, 762.4043579101562), (644.10546875, 760.905517578125), (645.10400390625, 761.4051513671875), (652.1549682617188, 761.4051513671875), (657.4178466796875, 761.4051513671875), (659.6140747070312, 761.4051513671875), (661.8714599609375, 761.4051513671875), (663.1115112304688, 761.4051513671875), (664.0776977539062, 761.4051513671875), (665.0762939453125, 761.4051513671875), (667.0735473632812, 762.4490356445312), (670.0693359375, 762.4043579101562), (665.0762939453125, 762.4043579101562), (654.4788208007812, 762.4043579101562), (626.1284790039062, 765.2484741210938), (593.2531127929688, 768.5277709960938), (552.7322998046875, 771.89697265625), (512.852783203125, 775.3189697265625), (485.0043640136719, 779.6112670898438), (457.54840087890625, 783.06982421875), (431.9969177246094, 784.38720703125), (401.3319396972656, 785.3864135742188), (365.5973815917969, 782.871337890625), (348.32452392578125, 781.4472045898438), (314.6293029785156, 780.3903198242188), (281.60888671875, 780.3903198242188), (247.7951202392578, 783.4596557617188), (235.3372802734375, 785.810791015625), (214.20249938964844, 789.38330078125), (205.2389373779297, 791.9458618164062), (194.47225952148438, 795.50732421875), (188.7378692626953, 796.3778076171875), (187.17298889160156, 797.3770751953125), (186.7406463623047, 798.8758544921875), (186.7406463623047, 798.3762817382812)], 0.033000)
        post_action(0.618004)
        perform_swipe_event([(650.0971069335938, 754.41064453125), (614.0670166015625, 757.32470703125), (589.570556640625, 759.6439208984375), (555.6730346679688, 764.0538330078125), (517.45654296875, 769.6015014648438), (489.85186767578125, 773.9349365234375), (445.2798156738281, 782.31298828125), (415.11456298828125, 789.0614624023438), (373.9227294921875, 797.7230224609375), (353.80413818359375, 801.2516479492188), (325.2574157714844, 806.799072265625), (292.0602722167969, 811.9093627929688), (276.6506042480469, 815.7813110351562), (240.28598022460938, 827.2225952148438), (208.80740356445312, 836.3241577148438), (193.2576446533203, 841.5006103515625), (169.7642059326172, 846.3388671875), (162.0313720703125, 848.91796875), (154.22409057617188, 851.6155395507812), (152.28085327148438, 852.5877075195312), (151.7891845703125, 853.3333129882812), (151.7891845703125, 854.3325805664062)], 0.033000)
        post_action(0.547598)
        perform_swipe_event([(267.6282958984375, 782.3887329101562), (305.3387145996094, 769.7037353515625), (366.64190673828125, 756.5504760742188), (431.3003234863281, 748.5707397460938), (494.3134765625, 746.4168701171875), (515.4869995117188, 747.95263671875), (559.9946899414062, 750.4591674804688), (579.4645385742188, 751.6051025390625), (594.9285278320312, 751.4129638671875), (635.5377807617188, 752.4121704101562), (647.924560546875, 752.4121704101562), (672.87451171875, 754.791259765625), (683.9506225585938, 757.3883666992188), (691.9381103515625, 758.964111328125), (700.1349487304688, 761.4051513671875)], 0.029000)
        post_action(0.427208)
        perform_swipe_event([(253.64772033691406, 781.3895263671875), (301.8891906738281, 774.5828247070312), (346.7565612792969, 777.197021484375), (370.6332092285156, 779.8516235351562), (415.07611083984375, 786.0194702148438), (479.1683044433594, 787.3848266601562), (503.6049499511719, 787.3848266601562), (560.221923828125, 784.8868408203125), (602.7227172851562, 777.4806518554688), (626.1819458007812, 773.2103881835938), (654.1621704101562, 768.0234375), (678.6189575195312, 767.4004516601562), (696.4622192382812, 768.4609375), (703.020263671875, 768.399658203125), (707.9095458984375, 767.4004516601562), (708.0166625976562, 767.4004516601562), (708.0166625976562, 766.4012451171875)], 0.033000)
        post_action(0.500031)
        perform_click_event("Tap", 572.205261, 402.685394, 0.099000, "Activity")
        post_action(1.010569)
        perform_swipe_event([(624.1331787109375, 723.434814453125), (599.3065185546875, 734.2191772460938), (583.4244384765625, 737.5513305664062), (553.9827270507812, 741.853515625), (528.5863037109375, 746.7525024414062), (480.1611328125, 756.5389404296875), (424.5840148925781, 769.4048461914062), (403.439697265625, 774.8945922851562), (363.35205078125, 785.9218139648438), (347.46942138671875, 788.5452270507812), (321.4766845703125, 794.120849609375), (311.5711975097656, 796.0026245117188), (297.1209716796875, 797.3770751953125), (288.4892578125, 798.3762817382812), (285.60333251953125, 798.3762817382812), (287.10125732421875, 798.3762817382812), (296.08026123046875, 798.3762817382812), (304.1932067871094, 798.3762817382812), (313.34429931640625, 798.3762817382812), (342.5597229003906, 800.9765625), (359.6353759765625, 802.96337890625), (398.27703857421875, 805.472412109375), (448.8765869140625, 804.8712158203125), (501.9613037109375, 800.49658203125), (527.0052490234375, 797.140380859375), (572.5429077148438, 792.503173828125), (610.56298828125, 789.6698608398438), (642.0921630859375, 787.11376953125), (656.8778686523438, 786.3856201171875), (665.4886474609375, 787.9309692382812), (681.8048095703125, 791.3197021484375), (689.5969848632812, 792.6398315429688), (700.5270385742188, 795.878173828125), (705.0208129882812, 798.3762817382812)], 0.033000)
        post_action(0.342750)
        perform_swipe_event([(385.4646301269531, 1146.1046142578125), (389.9584045410156, 1122.123291015625), (397.9031677246094, 1070.3150634765625), (408.8114013671875, 1003.6304321289062), (429.73052978515625, 916.2313232421875), (444.9827880859375, 853.9296875), (456.0024719238281, 815.637451171875), (474.81201171875, 756.2107543945312), (496.1969299316406, 699.01708984375), (513.6746215820312, 651.5972900390625), (533.0140380859375, 605.0186157226562), (547.5869140625, 571.5889892578125), (556.6024169921875, 553.81640625), (562.1204223632812, 539.825439453125), (565.69873046875, 534.0982666015625), (567.7115478515625, 529.586181640625), (573.38427734375, 519.2330932617188), (578.61572265625, 511.97100830078125), (583.7802124023438, 500.42706298828125), (588.3294677734375, 492.3222351074219), (593.1761474609375, 485.12103271484375), (596.9884033203125, 478.8995666503906), (602.3757934570312, 471.4193115234375), (606.388427734375, 462.7925109863281), (610.0238037109375, 456.0305480957031), (613.4677124023438, 451.3277282714844), (614.814208984375, 449.6487121582031), (615.6448974609375, 449.6487121582031), (612.7018432617188, 452.5408630371094), (589.6478881835938, 492.1396789550781), (551.444091796875, 566.1377563476562), (538.8343505859375, 592.480712890625), (510.2331237792969, 668.9660034179688), (499.83416748046875, 698.868896484375), (477.098388671875, 769.9549560546875), (461.0247802734375, 825.0279541015625), (448.5540466308594, 879.4277954101562), (443.6016540527344, 901.337646484375), (433.3980712890625, 959.7501831054688), (425.9269714355469, 995.3704223632812), (423.18914794921875, 1009.326904296875), (419.9857482910156, 1025.138427734375), (418.8350524902344, 1035.6904296875), (416.6024475097656, 1049.27490234375), (414.0185241699219, 1060.390869140625), (414.4244079589844, 1068.9598388671875), (413.4258117675781, 1072.2183837890625), (413.4258117675781, 1076.885009765625), (412.42718505859375, 1079.656494140625), (412.42718505859375, 1083.15380859375), (412.42718505859375, 1084.1529541015625)], 0.033000)
        post_action(0.765549)
        perform_click_event("Tap", 42.940361, 106.916473, 0.128000, "Activity")
        post_action(0.925794)
        perform_swipe_event([(516.282958984375, 374.7072448730469), (513.3904418945312, 397.8612060546875), (512.3899536132812, 442.7242431640625), (496.970458984375, 556.7200317382812), (491.3810119628906, 601.89501953125), (485.325927734375, 653.4894409179688), (480.5690002441406, 702.7218627929688), (478.148681640625, 730.3954467773438), (473.9182434082031, 772.6320190429688), (469.5458068847656, 817.1943359375), (463.5369873046875, 868.6461791992188), (463.74920654296875, 889.1588745117188), (463.3564453125, 904.7413330078125), (464.7572937011719, 910.094482421875), (464.3550720214844, 911.6948852539062), (464.3550720214844, 914.117431640625), (462.99383544921875, 918.009033203125), (463.3564453125, 921.0222778320312), (463.3564453125, 922.2794799804688)], 0.033000)
        post_action(0.438183)
        perform_swipe_event([(532.2607421875, 299.76580810546875), (523.8917236328125, 319.8126220703125), (516.4049072265625, 349.23870849609375), (506.1212158203125, 396.2756652832031), (502.33099365234375, 415.5035095214844), (492.93218994140625, 463.7078552246094), (483.643798828125, 511.7488098144531), (478.4822998046875, 543.6942138671875), (469.4307556152344, 595.87255859375), (466.4302062988281, 623.7326049804688), (464.12603759765625, 644.5606079101562), (460.4772644042969, 683.5314331054688), (460.3606262207031, 699.9491577148438), (458.4179382324219, 723.9428100585938), (457.3647766113281, 738.4298706054688), (454.5907897949219, 750.3030395507812), (453.3984375, 761.2644653320312), (450.8738098144531, 767.9000854492188), (449.60260009765625, 772.169677734375), (449.3758850097656, 774.6365356445312), (449.3758850097656, 776.89306640625), (448.37725830078125, 778.2317504882812), (448.37725830078125, 779.822265625), (448.37725830078125, 779.39111328125), (447.378662109375, 778.2952270507812), (447.378662109375, 775.5889282226562), (447.378662109375, 772.3966064453125), (448.37725830078125, 769.562255859375), (449.7577819824219, 765.6370239257812), (450.1219787597656, 761.6577758789062), (453.2731628417969, 752.6552734375), (458.3634033203125, 734.4262084960938), (460.492431640625, 726.904052734375), (467.5405578613281, 708.0037231445312), (472.92584228515625, 692.90478515625), (480.8737487792969, 666.0007934570312), (488.463623046875, 644.0233764648438), (495.75640869140625, 624.1775512695312), (503.0259094238281, 605.4910278320312), (507.3662414550781, 592.3599853515625), (511.28985595703125, 583.0445556640625), (512.5908203125, 579.5931396484375), (515.4517822265625, 573.0494995117188), (516.58154296875, 570.9558715820312), (518.9450073242188, 566.2261962890625), (520.1443481445312, 563.8259887695312), (520.2774047851562, 563.5596923828125)], 0.033000)
        post_action(0.743510)
        perform_click_event("Tap", 29.958391, 141.889145, 0.099000, "Activity")
        post_action(1.890201)
        perform_click_event("Tap", 54.923717, 108.914909, 0.098000, "Activity")
        post_action(0.000000)

    except Exception as e:
        print(e)
        traceback_str = ''.join(traceback.format_tb(e.__traceback__))
        print(traceback_str)
    clean_up()
    