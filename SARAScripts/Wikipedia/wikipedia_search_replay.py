# coding=utf8

import os
import sys
import time
import json
import frida
import argparse
import traceback
import uiautomator2 as u2
sys.path.append(os.path.abspath(os.getcwd()))
from script import util

frida_session = None
xml = None
view_hierarchy = None
save_path = None
action_count = 0
current_popup_window = None
curr_webview_address = None

d = u2.connect()
print(d.info)


def log(desc):
    global action_count
    print('[ReplayAction]-%d: ' % action_count, desc)


def error_handler(func):
    def wrapper(message, data):
        if message['type'] == 'error':
            print('[Func]: %s, [Error-msg]: %s' % (func.__name__, message))
            print('[Func]: %s, [Error-des]: %s' % (func.__name__, message['description']))
            print('[Func]: %s, [Error-sta]: %s' % (func.__name__, message['stack']))
            print('[Func]: %s, [Error-dat]: %s' % (func.__name__, data))
            return None
        else:
            return func(message, data)
    return wrapper


def preprocess_path():
    global save_path
    if save_path is None:
        return False
    if not os.path.exists(save_path):
        os.mkdir(save_path)
    else:
        for file in os.listdir(save_path):
            os.remove(os.path.join(save_path, file))
    return True


def post_action(custom_interval):
    global xml
    global d
    global action_count
    global save_path
    global view_hierarchy

    print('[ReplayTimeInterval]-%d: %s' % (action_count, json.dumps({'interval': custom_interval})))
    if action_count > 0:
        # time.sleep(1)
        if custom_interval > 0:
            time.sleep(custom_interval)
    xml = d.dump_hierarchy()
    xml = util.parse_xml(xml)
    screenshot_filename = os.path.join(save_path, '_'.join(['screenshot', str(action_count)]) + '.jpg')
    xml_filename = os.path.join(save_path, '_'.join(['ui', str(action_count)]) + '.xml')
    view_hierarchy_filename = os.path.join(save_path, '_'.join(['view_hierarchy', str(action_count)]) + '.xml')
    d.screenshot(screenshot_filename)
    util.save_xml(xml, xml_filename)
    view_hierarchy, lxml_view_hierarchy = util.dump_view_hierarchy(d, view_hierarchy_filename)
    action_count += 1


def set_text(rid, bounds, text):
    global xml
    view = util.find_view(rid, bounds, xml)
    if view is None:
        print('TextView ' + rid + ' does not exist')
        focused = d(focused=True)
        if focused.count > 0:
            d(focused=True).set_text(text)
        else:
            d.shell('input text "%s"' % text)
        log('[set_text]-%s' % json.dumps({'rid': rid, 'text': text, 'bounds': bounds}))
    else:
        if len(rid) > 0:
            d(resourceId=rid, focused=True).set_text(text)
        else:
            d(focused=True).set_text(text)
        log('[set_text]-%s' % json.dumps({'rid': rid, 'text': text, 'bounds': bounds}))


def press_soft_keyboard(key_name):
    global xml
    index = util.find_soft_key(key_name, xml)
    if index is None:
        raise Exception('Key ' + key_name + ' does not exist')
    key_x, key_y = index[0], index[1]
    d.click(key_x, key_y)
    log('[press_key]-%s' % json.dumps({'key_name': key_name}))


def hide_soft_keyboard():
    global xml
    if util.check_soft_keyboard(xml):
        print('Hide soft keyboard')
        d.press('back')
        log('[hide_keyboard]')


def record_popup_window():
    global current_popup_window
    current_popup_window = util.get_current_window(d)
    log('[record_popup_window]-%s' % json.dumps({'window': current_popup_window}))


def close_popup_window():
    global current_popup_window
    if current_popup_window is not None:
        window = util.get_current_window(d)
        if window == current_popup_window:
            d.press('back')
            log('[hide_popup_window]-%s' % json.dumps({'window': current_popup_window}))
            current_popup_window = None


def clean_up():
    global frida_session
    print('Clean Up....')
    frida_session.detach()


def detect_webview():
    # Get WebView handle
    global frida_session
    instrument_script = frida_session.create_script(util.instrument_WebView())
    instrument_script.on('message', get_instrument_WebView_message)
    instrument_script.load()


@error_handler
def get_instrument_WebView_message(message, data):
    global curr_webview_address
    print('[WebView]: ', message)
    curr_webview_address = util.get_view_address(message['payload']['webview'])


def perform_click_event(tap_type, x, y, duration, view_type):
    global action_count
    global view_hierarchy
    global frida_session

    if view_type == 'Activity':
        candidates = util.find_component_candidates(view_hierarchy, x, y)
        # Instrument
        instrument_script = None
        code = util.instrument_view([candidate['classname'] for candidate in candidates], [candidate['address'] for candidate in candidates], action_count)
        instrument_script = frida_session.create_script(code)
        instrument_script.on('message', get_instrument_view_message)
        instrument_script.load()
        if tap_type == 'LongTap':
            d.long_click(x, y, duration)
        elif tap_type == 'Tap':
            d.long_click(x, y, duration)
        elif tap_type == 'DoubleTap':
            d.double_click(x, y, 0.1)

        # time.sleep(1)
        instrument_script.unload()
        log('[click]-%s' % json.dumps({'tap_type': tap_type, 'x': x, 'y': y, 'duration': duration, 'candidate': candidates, 'view_type': view_type}))

    else:
        # Dialog & PopupWindow
        # command `adb shell dumpsys activity top` fails to extract view hierarchy of Dialog & PopupWindow
        if tap_type == 'LongTap':
            d.long_click(x, y, duration)
        elif tap_type == 'Tap':
            d.long_click(x, y, duration)
        elif tap_type == 'DoubleTap':
            d.double_click(x, y, 0.1)
        log('[click]-%s' % json.dumps({'tap_type': tap_type, 'x': x, 'y': y, 'duration': duration, 'view_type': view_type}))


@error_handler
def get_instrument_view_message(message, data):
    print('[ReplayViewInstrumentation]: %s' % json.dumps(message))


def perform_swipe_event(pointers, duration=0.01):
    d.swipe_points(pointers, duration)
    log('[swipe]-%s' % json.dumps({'pointers': pointers, 'duration': duration}))


def perform_key_event(key_code):
    d.press(key_code)
    log('[press]-%s' % json.dumps({'key_code': key_code}))


def webview_set_text(input_selector, text, webview_classname, package_name):
    # Set Text
    global curr_webview_address
    code = util.webview_set_text(input_selector, text, webview_classname, curr_webview_address, package_name)
    instrument_script = frida_session.create_script(code)
    instrument_script.on('message', get_webview_set_text_message)
    instrument_script.load()


def webview_set_text_with_u2(text):
    d(focused=True).set_text(text)
    log('[webview_set_text]-%s' % json.dumps({'text': text}))


@error_handler
def get_webview_set_text_message(message, data):
    print('[WebViewSetText]: ', message)


def instrument_chrome_client():
    code = util.instrument_chrome_client()
    script = frida_session.create_script(code)
    script.on('message', get_instrument_chrome_client_message)
    script.load()


@error_handler
def get_instrument_chrome_client_message(message, data):
    print('[Console]: ', message)


if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='Argument Parser')
    parser.add_argument('--path', help='save path', required=True)
    parser.add_argument('--package', help='package name', required=True)
    parser.add_argument('--pid', help='pid name', required=True)
    args = parser.parse_args()
    
    save_path = args.path
    package_name = args.package
    pid = int(args.pid)

    if not preprocess_path():
        print('Save path not found')
        sys.exit()

    # Setup Dynamic instrument   
    all_devices = frida.enumerate_devices()
    device = frida.get_usb_device()

    # Attach
    frida_session = device.attach(pid)
    print(frida_session)

    try:
        detect_webview()
        # instrument_chrome_client()
        post_action(0)

        perform_click_event("Tap", 467.350922, 230.819672, 0.042000, "Activity")
        post_action(3.164103)
        set_text("org.wikipedia:id/search_src_text", "[144,68][528,140]", "james")
        post_action(2.818195)
        perform_swipe_event([(473.34259033203125, 626.5105590820312), (479.3342590332031, 590.5386352539062), (481.33148193359375, 562.9774169921875), (487.4857177734375, 533.1881713867188), (496.3636169433594, 490.8085632324219), (503.0206604003906, 471.9003601074219), (514.4794921875, 440.0740966796875), (525.3336181640625, 410.8648681640625), (533.8526000976562, 394.5037841796875), (544.4100341796875, 373.3759460449219), (555.0993041992188, 355.41693115234375), (565.361328125, 336.4441223144531), (575.9369506835938, 319.7677307128906), (581.738525390625, 308.8924255371094), (588.5640869140625, 297.00494384765625), (592.297119140625, 290.6531982421875), (595.2218627929688, 285.728271484375), (597.7713012695312, 282.1780090332031), (599.0278930664062, 279.92144775390625), (599.1678466796875, 279.78143310546875)], 0.038500)
        post_action(0.391870)
        perform_click_event("Tap", 478.335663, 433.661194, 0.024000, "Activity")
        post_action(3.665300)
        perform_swipe_event([(502.3023681640625, 919.2817993164062), (501.613037109375, 899.2797241210938), (504.680908203125, 868.2216186523438), (506.8009948730469, 845.2908935546875), (510.0801696777344, 821.6832885742188), (513.6136474609375, 793.4561767578125), (518.0592041015625, 770.1154174804688), (521.2748413085938, 743.4305419921875), (524.8792724609375, 721.3951416015625), (529.264892578125, 700.952392578125), (532.4193725585938, 682.5135498046875), (536.752197265625, 661.7457885742188), (542.0860595703125, 639.6275024414062), (545.3693237304688, 622.7528076171875), (547.7392578125, 608.5245361328125), (551.1941528320312, 600.6517944335938), (553.3392333984375, 594.2125244140625), (554.90576171875, 589.8627319335938), (555.2288818359375, 589.5394287109375), (556.1934814453125, 589.5394287109375), (556.2274780273438, 589.5394287109375)], 0.033000)
        post_action(1.477026)
        perform_click_event("Tap", 275.617218, 559.562866, 0.068000, "Activity")
        post_action(1.900089)
        perform_swipe_event([(456.3661804199219, 1035.1912841796875), (472.2930603027344, 953.425048828125), (478.9295959472656, 922.1161499023438), (481.33148193359375, 906.7404174804688), (485.826416015625, 892.5486450195312), (491.792236328125, 875.5403442382812), (496.5385437011719, 861.642333984375), (501.30377197265625, 848.3372802734375), (504.25469970703125, 835.5719604492188), (507.6168518066406, 826.7103881835938), (511.6996154785156, 817.24609375), (514.2667236328125, 811.4041137695312), (518.759033203125, 801.414794921875), (521.2715454101562, 797.3815307617188), (523.8870239257812, 791.459716796875), (525.769775390625, 787.3848876953125), (528.4114379882812, 780.9537963867188), (531.7708129882812, 773.3771362304688), (535.9304809570312, 764.8901977539062), (541.7265625, 751.4971313476562), (543.724365234375, 744.5001220703125), (548.4999389648438, 737.0316162109375), (550.6882934570312, 731.0694580078125), (552.9713745117188, 725.9540405273438), (555.2288818359375, 721.9076538085938), (556.7097778320312, 716.4743041992188), (559.2056274414062, 712.461181640625), (560.5159912109375, 707.8580322265625), (561.8347778320312, 704.8342895507812), (562.2191772460938, 702.3295288085938), (563.2177734375, 701.1488647460938), (563.2177734375, 699.5430908203125), (564.2163696289062, 698.454345703125), (564.2163696289062, 697.4551391601562), (565.2149658203125, 697.4551391601562), (565.2149658203125, 696.4558715820312)], 0.033000)
        post_action(0.631288)
        perform_swipe_event([(406.4355163574219, 999.2193603515625), (407.30267333984375, 990.2532958984375), (412.42718505859375, 951.7564697265625), (420.7919006347656, 915.4033203125), (426.10577392578125, 888.2830200195312), (433.6106872558594, 860.4921875), (440.67950439453125, 832.1837158203125), (449.37591552734375, 803.372314453125), (458.088623046875, 773.2901000976562), (465.6859436035156, 745.9755249023438), (475.02294921875, 721.4003295898438), (482.1990661621094, 703.8001098632812), (487.1772766113281, 688.9000244140625), (494.6461486816406, 673.0302124023438), (501.22650146484375, 660.6128540039062), (506.796142578125, 649.4925537109375), (510.0535583496094, 642.9737548828125), (512.5204467773438, 638.2691040039062), (515.78369140625, 632.505859375), (519.097412109375, 626.87353515625), (521.6646118164062, 624.1232299804688), (521.2760009765625, 622.0743408203125), (522.7739868164062, 621.5144653320312), (522.274658203125, 621.5144653320312)], 0.033000)
        post_action(0.278225)
        perform_swipe_event([(546.2413330078125, 558.5635986328125), (537.2538452148438, 593.5363159179688), (531.2070922851562, 630.486328125), (525.769775390625, 674.9727172851562), (512.2838134765625, 749.8634643554688), (499.55889892578125, 810.05517578125), (488.82476806640625, 859.1881103515625), (483.9722900390625, 889.4383544921875), (479.33428955078125, 920.281005859375), (475.32147216796875, 945.4266357421875), (474.3412170410156, 958.8502197265625), (474.3412170410156, 963.9749755859375), (473.346923828125, 968.23486328125), (473.34259033203125, 975.584716796875), (472.5069885253906, 986.5762329101562), (471.020751953125, 1010.1611938476562), (470.34674072265625, 1026.1982421875), (469.34814453125, 1049.7528076171875), (467.08685302734375, 1068.5452880859375), (465.5001220703125, 1086.271484375), (465.35369873046875, 1099.86328125), (463.85736083984375, 1110.126220703125), (463.3564453125, 1119.378662109375), (462.35784912109375, 1121.5806884765625), (462.35784912109375, 1122.123291015625)], 0.033000)
        post_action(0.615360)
        perform_click_event("Tap", 553.231628, 529.586243, 0.055000, "Dialog")
        post_action(1.138473)
        perform_click_event("Tap", 298.585297, 613.520691, 0.082000, "Activity")
        post_action(1.431928)
        perform_click_event("Tap", 545.242737, 543.575317, 0.070000, "Dialog")
        post_action(0.784778)
        perform_swipe_event([(434.39666748046875, 1068.16552734375), (434.6219177246094, 1027.94140625), (447.7613220214844, 934.2762451171875), (462.6430358886719, 858.6157836914062), (471.9412841796875, 817.3253173828125), (483.9255676269531, 772.0061645507812), (498.6394958496094, 725.4371948242188), (510.1097106933594, 693.5308837890625), (519.1373291015625, 670.830078125), (524.2718505859375, 655.9874877929688), (531.5230102539062, 643.9744262695312), (539.9244995117188, 632.3819580078125), (544.3939208984375, 621.6392822265625), (548.873779296875, 614.0661010742188), (551.6204223632812, 608.7514038085938), (552.7322998046875, 606.5261840820312), (553.2316284179688, 607.525390625)], 0.033000)
        post_action(1.015573)
        perform_click_event("Tap", 647.101257, 969.242798, 0.068000, "Activity")
        post_action(1.238226)
        perform_swipe_event([(570.2080688476562, 759.40673828125), (621.6561279296875, 384.96759033203125), (625.123291015625, 367.7509460449219), (628.65869140625, 355.59503173828125), (630.8897705078125, 347.6643981933594), (632.1220703125, 339.6502685546875), (632.1220703125, 332.24041748046875), (633.1206665039062, 327.9479675292969), (634.4724731445312, 323.04022216796875), (634.1192626953125, 318.9538269042969), (634.1192626953125, 315.74981689453125), (634.1192626953125, 313.4646301269531), (635.6172485351562, 312.25604248046875), (635.117919921875, 310.7572326660156), (636.1165161132812, 308.5482177734375), (636.8983764648438, 307.7595520019531), (637.1151123046875, 307.7595520019531), (637.1151123046875, 306.7603454589844), (638.11376953125, 306.7603454589844)], 0.033000)
        post_action(0.584720)
        perform_swipe_event([(459.36199951171875, 931.2724609375), (462.5462646484375, 888.2307739257812), (466.3523254394531, 860.8274536132812), (471.8536071777344, 833.3131103515625), (477.0338439941406, 805.5406494140625), (482.1539001464844, 772.6315307617188), (487.3726806640625, 743.146728515625), (494.3355712890625, 718.6907348632812), (500.804443359375, 693.458251953125), (509.9609680175781, 663.4739990234375), (518.3331909179688, 639.3411865234375), (526.8063354492188, 616.904052734375), (533.6378784179688, 601.7719116210938), (540.2496337890625, 587.541015625), (546.1321411132812, 576.7681274414062), (550.4279174804688, 569.1705322265625), (554.230224609375, 563.5597534179688), (555.153076171875, 560.637939453125), (556.6027221679688, 560.5620727539062), (556.2274780273438, 558.8223876953125), (557.22607421875, 557.6215209960938), (558.2246704101562, 555.06640625), (560.221923828125, 552.835693359375), (561.2205200195312, 550.369873046875), (562.718505859375, 549.5706176757812), (562.2191772460938, 548.5714111328125), (562.2191772460938, 547.212890625), (563.6281127929688, 547.5722045898438), (563.2177734375, 547.5722045898438)], 0.033000)
        post_action(0.901091)
        perform_click_event("Tap", 642.108215, 164.871201, 0.111000, "Activity")
        post_action(0.637962)
        perform_swipe_event([(440.38836669921875, 1056.1748046875), (436.42169189453125, 1031.367919921875), (438.5298156738281, 1008.5457763671875), (447.2552490234375, 963.303466796875), (455.3308410644531, 925.424072265625), (461.5916748046875, 890.5513305664062), (465.9619445800781, 862.4761352539062), (470.367919921875, 838.2283935546875), (475.8391418457031, 814.8633422851562), (485.5450134277344, 779.1234741210938), (494.4718017578125, 749.2286376953125), (502.90447998046875, 719.3276977539062), (513.6785888671875, 690.0415649414062), (524.1895751953125, 657.7333984375), (530.1693725585938, 642.0516967773438), (536.52587890625, 629.6948852539062), (542.164794921875, 619.680419921875), (544.735595703125, 611.2841186523438), (549.8238525390625, 603.6471557617188), (552.6029052734375, 597.422119140625), (557.1861572265625, 590.5785522460938), (559.501220703125, 585.9856567382812), (560.221923828125, 584.043701171875), (561.2205200195312, 582.5448608398438)], 0.033000)
        post_action(0.446911)
        perform_swipe_event([(713.0097045898438, 805.3707885742188), (692.8646850585938, 802.3472290039062), (670.4146118164062, 802.3731689453125), (654.3485107421875, 803.8505249023438), (627.5941772460938, 806.8364868164062), (597.56103515625, 811.9671020507812), (570.4735717773438, 817.453857421875), (477.5752868652344, 832.397216796875), (451.02349853515625, 836.1429443359375), (433.775634765625, 838.4530639648438), (405.79205322265625, 841.7830810546875), (386.7685546875, 843.5829467773438), (356.31939697265625, 846.1993408203125), (339.96551513671875, 847.4580688476562), (324.15869140625, 848.7861328125), (302.44134521484375, 848.3372192382812), (285.31842041015625, 849.33642578125), (262.36199951171875, 850.335693359375), (247.70289611816406, 850.335693359375), (223.7090301513672, 852.7847290039062), (208.21823120117188, 854.2935791015625), (169.6819610595703, 859.089111328125), (159.31613159179688, 858.3294067382812), (142.29124450683594, 859.3286743164062), (120.02900695800781, 859.3286743164062), (110.99180603027344, 859.3286743164062), (104.26394653320312, 859.3286743164062), (88.6539306640625, 860.1058959960938), (76.91020202636719, 860.327880859375), (64.53639221191406, 861.3270874023438), (57.863525390625, 862.3262939453125), (49.656612396240234, 863.3255004882812), (44.47655487060547, 864.4401245117188), (35.950069427490234, 864.3247680664062), (36.46527099609375, 864.3247680664062), (34.95145797729492, 864.3247680664062), (32.95423126220703, 864.3247680664062), (32.95423126220703, 865.8236083984375), (30.95700454711914, 865.323974609375)], 0.032000)
        post_action(0.452719)
        perform_click_event("Tap", 542.246887, 453.645599, 0.054000, "Activity")
        post_action(2.196663)
        perform_swipe_event([(442.3855895996094, 999.2193603515625), (449.8638916015625, 961.8051147460938), (455.0393371582031, 938.9098510742188), (459.6100769042969, 918.1647338867188), (462.2981262207031, 899.5364379882812), (467.22967529296875, 876.8612670898438), (472.6261291503906, 856.4832153320312), (477.7152404785156, 834.5225219726562), (481.2701721191406, 819.72802734375), (486.1548767089844, 805.2957153320312), (488.11614990234375, 794.9966430664062), (490.3117370605469, 789.4050903320312), (492.8155212402344, 784.38720703125), (494.3134765625, 780.5896606445312), (495.31207275390625, 778.138427734375), (496.3106994628906, 775.1212768554688), (497.176025390625, 772.5299072265625), (497.3092956542969, 769.9321899414062), (498.30792236328125, 767.7633056640625), (499.3065185546875, 765.2822875976562), (500.3051452636719, 764.40283203125), (501.3037414550781, 763.403564453125)], 0.033000)
        post_action(1.256761)
        perform_swipe_event([(448.37725830078125, 1051.1787109375), (448.37725830078125, 1030.1951904296875), (456.2074279785156, 981.9747314453125), (465.7038269042969, 933.9674682617188), (471.822021484375, 906.4277954101562), (480.2953186035156, 873.7084350585938), (492.2028503417969, 830.691650390625), (502.2744445800781, 793.4863891601562), (513.7864379882812, 754.9102172851562), (521.5072631835938, 726.1223754882812), (534.63330078125, 693.60595703125), (546.3370361328125, 667.6675415039062), (557.510009765625, 642.0728759765625), (568.0130615234375, 617.0131225585938), (577.0670776367188, 601.792724609375), (584.4077758789062, 587.9920654296875), (590.073974609375, 578.7608642578125), (595.3458251953125, 571.3809204101562), (599.4237670898438, 565.0460205078125), (601.1650390625, 561.005615234375), (602.1636962890625, 560.5620727539062), (602.1636962890625, 559.063232421875), (603.1622924804688, 559.5628662109375), (603.1622924804688, 558.5635986328125), (603.1622924804688, 557.4888305664062), (603.1622924804688, 557.5643920898438)], 0.033000)
        post_action(0.875779)
        perform_swipe_event([(426.40777587890625, 1101.1397705078125), (427.4037170410156, 1064.190185546875), (433.44384765625, 1027.9217529296875), (439.8197937011719, 995.8789672851562), (445.39141845703125, 969.2061767578125), (452.87103271484375, 944.7618408203125), (458.8682861328125, 921.927734375), (464.25714111328125, 903.1898193359375), (467.6830139160156, 887.3090209960938), (471.12286376953125, 875.9840698242188), (476.33843994140625, 860.3278198242188), (478.98858642578125, 854.3709716796875), (482.4627380371094, 842.6775512695312), (485.7798767089844, 833.5307006835938), (488.09088134765625, 828.81494140625), (489.6614685058594, 823.6734008789062), (490.6937255859375, 821.9826049804688), (491.317626953125, 820.3590698242188)], 0.033000)
        post_action(0.399528)
        perform_click_event("Tap", 481.331482, 535.581604, 0.081000, "Activity")
        post_action(1.501181)
        perform_click_event("Tap", 633.120667, 471.631531, 0.056000, "Dialog")
        post_action(0.931431)
        perform_swipe_event([(431.4008483886719, 1014.2076416015625), (432.73291015625, 990.2156372070312), (448.3689880371094, 914.8143310546875), (460.9221496582031, 869.07177734375), (467.84228515625, 842.3737182617188), (474.3411865234375, 816.86181640625), (483.33319091796875, 787.3670654296875), (490.76727294921875, 762.608642578125), (500.2077941894531, 732.719970703125), (510.2666015625, 702.5088500976562), (523.4663696289062, 665.8994750976562), (536.1424560546875, 637.5423583984375), (549.2242431640625, 608.5526123046875), (565.2150268554688, 582.0452270507812), (574.40283203125, 565.9568481445312), (580.7157592773438, 554.522216796875), (585.4234619140625, 545.7188110351562), (589.8909301757812, 539.0135498046875), (594.0699462890625, 533.68798828125), (595.6427001953125, 529.6463012695312), (597.2568359375, 528.5870361328125), (597.1705932617188, 527.5878295898438), (598.1692504882812, 525.8855590820312), (600.3977661132812, 523.3594360351562), (602.4711303710938, 521.284912109375), (603.1622924804688, 518.6983642578125), (604.3365478515625, 516.420654296875), (605.6588134765625, 515.59716796875), (605.1594848632812, 514.5979614257812), (606.1581420898438, 514.5979614257812), (607.15673828125, 514.5979614257812)], 0.033000)
        post_action(0.484556)
        perform_swipe_event([(449.3758850097656, 912.2872924804688), (453.7723693847656, 862.715576171875), (461.0849304199219, 831.4491577148438), (467.2298583984375, 808.9841918945312), (471.6836853027344, 790.688232421875), (480.88873291015625, 759.7366333007812), (489.2388610839844, 733.1925048828125), (501.7923583984375, 701.27783203125), (511.3841552734375, 671.0302734375), (522.77392578125, 642.498046875), (535.4818115234375, 613.8244018554688), (544.559814453125, 596.9013061523438), (556.9376831054688, 576.0553588867188), (563.6784057617188, 561.1776733398438), (570.7073974609375, 550.0702514648438), (577.3763427734375, 540.3402099609375), (580.3841552734375, 534.01220703125), (582.9550170898438, 529.8213500976562), (584.2294311523438, 527.5469970703125), (584.1886596679688, 527.5878295898438), (584.1886596679688, 526.588623046875)], 0.033000)
        post_action(0.856482)
        perform_swipe_event([(710.0138549804688, 666.4793090820312), (691.0402221679688, 665.4801025390625), (657.687255859375, 666.4793090820312), (632.0654907226562, 671.4161376953125), (602.671142578125, 678.0932006835938), (568.0248413085938, 689.84033203125), (541.2528686523438, 699.6331176757812), (511.9016418457031, 712.0742797851562), (483.9813232421875, 719.2202758789062), (459.338623046875, 724.6220703125), (423.44317626953125, 733.5608520507812), (394.5093994140625, 738.1294555664062), (364.1533203125, 743.3643188476562), (333.89398193359375, 747.9013061523438), (288.59918212890625, 754.91015625), (247.6598358154297, 761.7791748046875), (214.93487548828125, 763.6387939453125), (181.99366760253906, 766.2141723632812), (159.48985290527344, 768.5284423828125), (137.80859375, 769.8985595703125), (118.30281066894531, 772.3381958007812), (103.22454071044922, 773.4860229492188), (90.37448120117188, 775.893798828125), (79.29592895507812, 775.3942260742188), (70.77664184570312, 774.0203247070312), (64.41567993164062, 774.39501953125), (60.001251220703125, 774.39501953125), (55.922332763671875, 774.39501953125), (54.9237174987793, 774.39501953125)], 0.033000)
        post_action(0.400854)
        perform_click_event("Tap", 485.325958, 568.555786, 0.026000, "Activity")
        post_action(2.548510)
        perform_swipe_event([(529.264892578125, 1045.1834716796875), (525.2704467773438, 1009.1886596679688), (526.4058837890625, 982.7255859375), (528.6790161132812, 954.88134765625), (531.9827270507812, 927.3380126953125), (534.5384521484375, 899.4888916015625), (537.58935546875, 880.2883911132812), (541.2163696289062, 851.68603515625), (543.5128784179688, 827.675537109375), (546.7406005859375, 801.87353515625), (552.4647827148438, 775.2340087890625), (555.6823120117188, 754.3673095703125), (561.834228515625, 727.3592529296875), (566.4298095703125, 706.5821533203125), (572.70458984375, 687.462890625), (578.073974609375, 667.9708251953125), (582.2889404296875, 655.9015502929688), (585.5167236328125, 645.5008544921875), (587.1845092773438, 639.6607666015625), (588.18310546875, 638.1348266601562), (588.9076538085938, 638.5011596679688), (589.1817016601562, 638.5011596679688)], 0.033000)
        post_action(1.467222)
        perform_swipe_event([(423.41192626953125, 1121.1241455078125), (424.62152099609375, 1086.025390625), (436.5164794921875, 1044.4736328125), (442.486328125, 1015.5509033203125), (453.0691223144531, 968.8834228515625), (460.49127197265625, 933.681884765625), (467.2031555175781, 902.886474609375), (473.9638977050781, 876.700439453125), (483.6908874511719, 847.2500610351562), (493.97332763671875, 816.3839721679688), (504.0830383300781, 784.2005615234375), (518.2802124023438, 742.4200439453125), (528.9645385742188, 713.0444946289062), (540.33642578125, 691.7205810546875), (548.238525390625, 674.47314453125), (558.4559326171875, 657.8308715820312), (566.3809204101562, 639.7757568359375), (573.4944458007812, 629.9259643554688), (581.3529663085938, 618.3031005859375), (584.9190063476562, 609.0614624023438), (587.683837890625, 604.5277099609375), (592.56591796875, 599.1430053710938), (593.4617919921875, 597.2473754882812), (594.1747436523438, 595.6513671875), (594.1747436523438, 595.03515625), (594.1747436523438, 595.5347290039062)], 0.033000)
        post_action(0.599823)
        perform_swipe_event([(443.3841857910156, 1119.125732421875), (447.7298278808594, 1087.2384033203125), (450.40411376953125, 1076.547607421875), (459.3900451660156, 1035.0322265625), (464.9697265625, 1001.9086303710938), (470.34674072265625, 974.2388916015625), (479.93206787109375, 937.0230712890625), (487.0998229980469, 909.9249267578125), (495.818115234375, 881.9552001953125), (502.6709289550781, 858.099365234375), (512.2884521484375, 830.8509521484375), (520.2318115234375, 809.4893188476562), (526.8088989257812, 790.1664428710938), (539.519775390625, 765.9978637695312), (549.1973266601562, 746.4886474609375), (557.9711303710938, 730.8099365234375), (565.5110473632812, 714.4971313476562), (572.231689453125, 702.3983764648438), (579.6948852539062, 688.9617309570312), (583.009521484375, 680.1915283203125), (587.7533569335938, 672.6200561523438), (590.8245239257812, 667.1885986328125), (592.1775512695312, 663.7379760742188), (593.1761474609375, 662.03515625), (594.1747436523438, 662.482421875), (595.1033935546875, 661.55322265625), (595.1734008789062, 661.4832153320312)], 0.033000)
        post_action(0.997270)
        perform_swipe_event([(712.0111083984375, 848.3372192382812), (686.4801635742188, 842.2547607421875), (659.583984375, 842.3419189453125), (645.0333251953125, 842.3419189453125), (623.4560546875, 842.3419189453125), (597.9323120117188, 844.7637329101562), (576.9163818359375, 846.124267578125), (556.2764282226562, 849.3255615234375), (542.0899047851562, 851.9085083007812), (514.7850341796875, 857.829833984375), (481.5168762207031, 860.327880859375), (466.8135070800781, 862.8701782226562), (438.5584411621094, 865.9446411132812), (413.00848388671875, 868.1778564453125), (397.2875061035156, 868.3215942382812), (362.49658203125, 869.3208618164062), (329.5000305175781, 871.2456665039062), (314.1002197265625, 871.3192749023438), (284.42578125, 872.3184814453125), (256.6849670410156, 872.5947875976562), (242.34988403320312, 872.3184814453125), (214.9150848388672, 872.3184814453125), (203.82662963867188, 872.3184814453125), (178.18231201171875, 871.3192749023438), (170.03347778320312, 871.3192749023438), (151.2898712158203, 870.320068359375), (138.2247314453125, 868.5575561523438), (124.47306060791016, 867.0968627929688), (119.82919311523438, 866.1224365234375), (108.77279663085938, 865.323974609375), (99.72306823730469, 864.3247680664062), (92.93843841552734, 863.3255004882812), (86.1984634399414, 861.486083984375), (83.85826873779297, 861.3270874023438), (80.27412414550781, 861.3270874023438), (79.33161926269531, 861.3270874023438), (77.89181518554688, 861.3270874023438), (76.74847412109375, 861.3270874023438), (72.39788818359375, 862.5768432617188), (67.20252990722656, 863.3255004882812), (65.1453857421875, 864.2069091796875), (64.90985107421875, 864.3247680664062)], 0.033000)
        post_action(0.484289)
        perform_click_event("Tap", 400.443848, 784.387207, 0.055000, "Activity")
        post_action(2.046931)
        perform_swipe_event([(519.27880859375, 946.2607421875), (518.537109375, 923.9974365234375), (522.0676879882812, 829.2533569335938), (524.2622680664062, 800.4901123046875), (529.9002075195312, 765.2213745117188), (537.3955078125, 730.6471557617188), (546.0111694335938, 686.590087890625), (554.6625366210938, 649.7608642578125), (562.7445678710938, 616.0460815429688), (574.3270263671875, 573.3279418945312), (581.5783081054688, 541.1851806640625), (589.4403076171875, 507.65380859375), (595.3928833007812, 485.9607849121094), (601.5692749023438, 472.11932373046875), (604.387451171875, 462.9576110839844), (605.4625244140625, 460.3369445800781), (607.0509033203125, 454.8565979003906), (609.3264770507812, 451.474609375), (610.65185546875, 446.65106201171875), (612.1331787109375, 444.66925048828125), (612.1497802734375, 443.53839111328125), (613.1484375, 442.6541748046875), (614.5175170898438, 442.6541748046875)], 0.033000)
        post_action(0.484689)
        perform_swipe_event([(364.4937744140625, 1098.14208984375), (366.6817321777344, 1067.020263671875), (383.62158203125, 997.3148193359375), (397.96600341796875, 943.5089721679688), (405.1766052246094, 912.2210083007812), (410.8249816894531, 887.724365234375), (420.71514892578125, 855.3585205078125), (431.491455078125, 821.0863037109375), (442.2278747558594, 785.4391479492188), (455.6809997558594, 747.7368774414062), (466.0176696777344, 716.1128540039062), (489.79248046875, 661.6547241210938), (504.6994323730469, 627.4755859375), (518.2802124023438, 602.0296630859375), (529.47021484375, 583.2359619140625), (536.7993774414062, 572.6443481445312), (544.5429077148438, 558.7315063476562), (552.37255859375, 548.38525390625), (558.2008056640625, 539.6261596679688), (563.0953979492188, 531.9521484375), (566.3043823242188, 527.4970092773438), (568.7100830078125, 524.090576171875), (570.2080688476562, 521.72998046875), (571.2066650390625, 520.59326171875)], 0.033000)
        post_action(0.584239)
        perform_swipe_event([(713.0097045898438, 776.3934326171875), (657.08740234375, 772.3965454101562), (628.5552368164062, 778.8201904296875), (604.831787109375, 782.9429931640625), (512.7571411132812, 805.2536010742188), (478.06866455078125, 813.4771118164062), (437.4800109863281, 824.2661743164062), (422.8047180175781, 826.8756103515625), (388.8241882324219, 833.6278076171875), (374.7637023925781, 835.1718139648438), (338.7573547363281, 842.5786743164062), (313.37322998046875, 846.9151611328125), (288.4990539550781, 851.5548095703125), (258.1625671386719, 858.1724243164062), (233.60032653808594, 861.7418212890625), (212.71456909179688, 865.89208984375), (196.90924072265625, 867.6742553710938), (176.18206787109375, 870.2667846679688), (155.4898223876953, 873.8272094726562), (143.4079132080078, 875.3946533203125), (122.09142303466797, 878.087890625), (100.77788543701172, 879.3130493164062), (94.4609375, 880.5132446289062), (79.05783081054688, 880.312255859375), (70.54866027832031, 880.312255859375), (65.81719970703125, 881.3114624023438), (60.98783493041992, 881.3114624023438), (55.730201721191406, 882.4067993164062), (54.441001892089844, 882.3106689453125), (54.9237174987793, 883.3099365234375)], 0.033000)
        post_action(1.951636)
        perform_click_event("Tap", 428.404999, 1024.199829, 0.067000, "Activity")
        post_action(1.644873)
        perform_swipe_event([(410.4299621582031, 1071.1632080078125), (417.16748046875, 1038.803466796875), (431.4087219238281, 963.2080078125), (437.519287109375, 920.4557495117188), (441.5765380859375, 891.6455688476562), (451.461181640625, 851.7537231445312), (460.5773010253906, 814.4415283203125), (473.7635803222656, 771.679443359375), (489.50531005859375, 728.526123046875), (503.6282653808594, 689.4782104492188), (522.2745971679688, 645.4957275390625), (541.2930297851562, 603.5582885742188), (559.5374145507812, 568.2576293945312), (573.4098510742188, 541.5664672851562), (582.0310668945312, 523.1533813476562), (590.6796264648438, 510.6011047363281), (596.5753784179688, 503.5007019042969), (598.3524169921875, 500.4256286621094), (599.6671142578125, 500.60888671875), (599.1678466796875, 500.60888671875)], 0.033000)
        post_action(0.499921)
        perform_swipe_event([(712.0111083984375, 736.4246826171875), (697.1019897460938, 736.4246826171875), (642.3090209960938, 740.8960571289062), (599.6671752929688, 747.9157104492188), (551.8609008789062, 759.7677001953125), (518.271728515625, 770.4009399414062), (478.75762939453125, 784.1039428710938), (461.39935302734375, 788.6685180664062), (407.952392578125, 802.3923950195312), (383.4674072265625, 807.8688354492188), (342.27276611328125, 812.268310546875), (320.54168701171875, 814.4703369140625), (282.518310546875, 820.1204223632812), (256.35308837890625, 823.75439453125), (231.33815002441406, 825.3551635742188), (205.873779296875, 826.3544311523438), (173.2440643310547, 828.3528442382812), (142.74400329589844, 828.0982055664062), (114.84050750732422, 826.85400390625), (93.19343566894531, 826.3544311523438), (75.2396469116211, 825.3551635742188), (63.718990325927734, 823.5584716796875), (55.66531753540039, 822.2718505859375), (50.429962158203125, 822.3575439453125), (45.082401275634766, 821.3583374023438), (44.93758773803711, 821.3583374023438)], 0.033000)
        post_action(0.614984)
        perform_swipe_event([(381.4701843261719, 1082.154541015625), (388.1526794433594, 1033.042236328125), (395.0010986328125, 997.6094970703125), (403.6341857910156, 950.5518188476562), (419.02020263671875, 886.8985595703125), (429.6998291015625, 845.0718994140625), (439.314453125, 805.6721801757812), (449.8379211425781, 761.1396484375), (458.58734130859375, 728.5132446289062), (475.15863037109375, 670.0467529296875), (489.93994140625, 631.4556274414062), (498.49853515625, 612.0763549804688), (509.99078369140625, 581.364501953125), (522.267333984375, 549.3445434570312), (532.2607421875, 525.0897216796875), (541.6319580078125, 505.83642578125), (549.5912475585938, 488.9089660644531), (553.4588012695312, 480.78314208984375), (555.3286743164062, 475.528564453125), (555.2288818359375, 474.6291809082031), (556.2274780273438, 473.6299743652344)], 0.033000)
        post_action(0.480005)
        perform_swipe_event([(374.4798889160156, 1078.15771484375), (375.6341247558594, 1055.0592041015625), (379.9947204589844, 1030.7984619140625), (391.5298156738281, 983.9368286132812), (401.02197265625, 940.6599731445312), (412.926513671875, 900.7962646484375), (415.921142578125, 887.935791015625), (421.3506164550781, 864.6133422851562), (432.9664001464844, 818.2033081054688), (444.91729736328125, 770.2573852539062), (450.16265869140625, 750.777099609375), (459.6408386230469, 710.6478271484375), (461.8467712402344, 696.2472534179688), (475.1254577636719, 655.9290771484375), (482.208251953125, 637.8067626953125), (488.22113037109375, 622.7654418945312), (501.80303955078125, 590.53857421875), (508.650390625, 571.839599609375), (514.788818359375, 558.3043212890625), (517.9024047851562, 552.3250122070312), (524.72705078125, 537.668212890625), (526.965087890625, 532.3416748046875), (533.1298828125, 520.8523559570312), (535.256591796875, 518.09521484375), (537.1749877929688, 515.2158813476562), (538.1705322265625, 513.6807250976562), (539.2510375976562, 511.5306091308594), (539.2510375976562, 510.2117614746094), (540.7490234375, 510.6011047363281), (540.2496948242188, 510.6011047363281)], 0.032000)
        post_action(0.384056)
        perform_click_event("Tap", 381.470184, 1023.200623, 0.085000, "Activity")
        post_action(1.562732)
        perform_click_event("Tap", 633.120667, 374.707245, 0.083000, "Activity")
        post_action(3.517732)
        perform_swipe_event([(406.4355163574219, 909.2896118164062), (408.8905029296875, 893.9365844726562), (415.7283935546875, 862.2052001953125), (427.9254150390625, 819.5406494140625), (436.8245849609375, 786.5182495117188), (446.23919677734375, 743.98291015625), (455.3045654296875, 713.1793212890625), (469.02581787109375, 668.446044921875), (482.8971252441406, 633.0858154296875), (494.1827697753906, 609.3511352539062), (507.8139343261719, 576.5111694335938), (518.0731811523438, 555.9801635742188), (532.4983520507812, 524.6094970703125), (542.2469482421875, 509.6018981933594), (552.5695190429688, 490.02752685546875), (562.7974853515625, 472.314453125), (567.0347290039062, 465.9914245605469), (569.20947265625, 460.83074951171875), (570.7073974609375, 460.1405334472656), (569.582275390625, 461.63934326171875), (566.4501953125, 468.04205322265625), (557.8438110351562, 493.758544921875), (532.7772216796875, 551.3624267578125), (512.007568359375, 611.446044921875), (496.80999755859375, 661.9827880859375), (484.86077880859375, 697.545654296875), (475.6324462890625, 736.252685546875), (467.8334655761719, 763.45947265625), (462.8276062011719, 785.2695922851562), (459.03228759765625, 806.0115966796875), (456.9655456542969, 817.3602905273438), (453.3512878417969, 829.39013671875), (452.3717041015625, 835.9800415039062), (451.37310791015625, 838.8446044921875), (451.37310791015625, 840.8431396484375), (451.37310791015625, 840.343505859375)], 0.033000)
        post_action(0.446767)
        perform_click_event("Tap", 652.094299, 310.757233, 0.112000, "Activity")
        post_action(1.160770)
        perform_swipe_event([(472.3439636230469, 1000.2185668945312), (471.3453674316406, 952.0400390625), (476.0768737792969, 900.970947265625), (480.99346923828125, 852.8878173828125), (488.2210388183594, 802.0796508789062), (495.3580017089844, 750.092041015625), (503.0128479003906, 706.1796264648438), (515.7836303710938, 660.4840087890625), (530.0420532226562, 622.5441284179688), (546.0279541015625, 578.874267578125), (561.7197875976562, 542.576171875), (573.8303833007812, 509.5759582519531), (584.5679931640625, 479.830322265625), (594.1612548828125, 464.45880126953125), (601.1884765625, 451.6002197265625), (604.462646484375, 444.7459411621094), (605.1594848632812, 440.65576171875), (606.1581420898438, 441.65496826171875)], 0.033000)
        post_action(0.431076)
        perform_swipe_event([(718.0028076171875, 703.450439453125), (649.5679321289062, 702.8938598632812), (621.525146484375, 708.5993041992188), (593.580322265625, 714.96044921875), (511.13043212890625, 743.1485595703125), (471.3045959472656, 753.873046875), (445.74420166015625, 759.8858032226562), (437.4692077636719, 763.044921875), (409.60491943359375, 767.0055541992188), (397.43206787109375, 769.0684814453125), (361.66131591796875, 775.6447143554688), (335.10491943359375, 778.3104248046875), (298.2928161621094, 781.4756469726562), (266.9781799316406, 783.7913208007812), (246.14540100097656, 786.0255126953125), (207.98143005371094, 787.3848266601562), (187.11614990234375, 788.6104125976562), (159.78335571289062, 790.7151489257812), (143.7626953125, 792.13427734375), (123.25765228271484, 794.37939453125), (104.35507202148438, 795.3786010742188), (90.501220703125, 796.3778076171875), (73.40209197998047, 798.58984375), (63.91123580932617, 799.37548828125), (57.286251068115234, 801.191162109375), (54.79452133178711, 801.3739013671875), (53.42580032348633, 801.3739013671875), (50.14421081542969, 800.4815673828125), (48.862979888916016, 797.2388916015625)], 0.033000)
        post_action(0.600640)
        perform_swipe_event([(360.49932861328125, 1092.146728515625), (371.9474792480469, 1035.10302734375), (381.8968200683594, 995.7986450195312), (398.7679748535156, 923.4999389648438), (407.0167236328125, 879.5891723632812), (409.9306640625, 863.8251342773438), (421.0165710449219, 820.7940063476562), (425.6859436035156, 802.2645263671875), (436.0380859375, 766.6480712890625), (439.36328125, 751.5189208984375), (441.7999572753906, 740.3538208007812), (444.21441650390625, 730.1041259765625), (448.11328125, 719.4762573242188), (450.1231384277344, 711.8248291015625), (452.0194091796875, 707.8289794921875), (453.1085510253906, 702.23779296875), (454.2929992675781, 698.6822509765625), (456.24945068359375, 693.750244140625), (458.7944030761719, 687.3839721679688), (463.3564453125, 672.9742431640625), (471.4500427246094, 654.2094116210938), (474.87548828125, 646.2467651367188), (478.9884338378906, 639.3565673828125), (483.79913330078125, 626.8325805664062), (487.3248596191406, 616.5115966796875), (489.76043701171875, 610.6416015625), (490.3190002441406, 610.5230102539062)], 0.017000)
        post_action(0.499811)
        perform_click_event("Tap", 356.504852, 1208.056152, 0.082000, "Activity")
        post_action(2.464677)
        perform_click_event("Tap", 78.890434, 1249.024170, 0.099000, "Activity")
        post_action(0.621815)
        record_popup_window()
        post_action(3.801987)
        close_popup_window()
        post_action(1.292048)
        perform_click_event("Tap", 700.027771, 101.920372, 0.039000, "Activity")
        post_action(0.078139)
        record_popup_window()
        post_action(2.443540)
        perform_click_event("Tap", 571.206665, 304.761902, 0.083000, "None")
        post_action(0.069037)
        close_popup_window()
        post_action(1.549809)
        perform_click_event("Tap", 363.495148, 1177.080444, 0.084000, "Dialog")
        post_action(3.217119)
        perform_click_event("Tap", 55.922333, 109.914131, 0.087000, "Activity")
        post_action(0.000000)

    except Exception as e:
        print(e)
        traceback_str = ''.join(traceback.format_tb(e.__traceback__))
        print(traceback_str)
    clean_up()
    